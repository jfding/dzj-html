{% extends "_list.html" %}
{% block custom-css %}
<link href="{{static_url('assets/jquery-multi-select/multi-select.css')}}" rel="stylesheet"/>
<link href="{{static_url('assets/select2/select2.css')}}" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
<link href="{{static_url('css/task-admin.css')}}" rel="stylesheet"/>
{% end %}

{% block custom-modal %}
{% module ComModal([{'id': 'batch', 'name': '批次'}], 'batchModal', '更新批次') %}
<div id="helpModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="helpModal"
     aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h4 class="modal-title">帮助文档</h4>
      </div>
      <div class="modal-body">
        <div class="title">一、简介</div>
        <div class="intro">
          任务管理模块提供管理员对任务进行操作，包括批量删除、批量指派、更新批次、综合检索、结果统计等，针对
          每个任务，还可以浏览、查看详情、查看历程、删除任务以及重新发布。<br/>
          注：浏览指的是针对检索结果的浏览，浏览时可以对任务进行具体的操作。
        </div>
        <div class="title">二、操作</div>
        <table class="table">
          <tr>
            <td>批量删除</td>
            <td>可以删除「已发布未完成」「等待前置任务」「已退回」的任务。管理发布任务有误时，可以批量删除后再进行发布。
              如果需要删除「进行中」的任务，请先选择重新发布，然后再删除。
            </td>
          </tr>
          <tr>
            <td>批量指派</td>
            <td>将「已发布」的任务指派给某个特定的用户</td>
          </tr>
          <tr>
            <td>更新批次</td>
            <td>批量更新选中任务的批次。批次是一种很好的任务分类方式</td>
          </tr>
          <tr>
            <td>综合检索</td>
            <td>可以针对任务的各个字段进行检索。比如检索某批次的任务，或者某人领取的任务等。</td>
          </tr>
          <tr>
            <td>结果统计</td>
            <td>可以针对检索结果，按照用户、任务类型、任务状态等三个角度进行统计。</td>
          </tr>
          <tr>
            <td>浏览</td>
            <td>逐条浏览检索结果，在浏览任务时，可以对任务进行备注等</td>
          <tr>
            <td>详情</td>
            <td>查看任务详情</td>
          <tr>
            <td>历程</td>
            <td>任务相关的页面发布的所有任务</td>
          </tr>
          <tr>
            <td>删除</td>
            <td>可以删除「已发布未完成」「等待前置任务」「已退回」的任务。如果需要删除「进行中」的任务，请先选择重新发布，然后再删除。</td>
          </tr>
          <tr>
            <td>重新发布</td>
            <td>重新发布指的是对于「进行中」的任务，从用户处撤回后重新发布。</td>
          </tr>
        </table>
      </div>
    </div>
  </div>
</div>
<div id="searchModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="searchModal" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-body" style="height: 470px; padding: 0">
        <h4 class="col-sm-2 control-label">批次号</h4>
        <div class="col-sm-10">
          <input type="text" class="form-control batch" value="{{params.get('batch') or ''}}" placeholder="请输入批次号">
        </div>
        <h4 class="col-sm-2 control-label">页编码</h4>
        <div class="col-sm-10">
          <input type="text" class="form-control doc_id" value="{{params.get('doc_id') or ''}}" placeholder="请输入页编码">
        </div>
        <h4 class=" col-sm-2 control-label">任务类型</h4>
        <div class="col-sm-10">
          <select class="form-control task_type">
            <option value=""></option>
            {% for k, name in handler.get_task_types(collection).items() %}
            {% if params.get('task_type') and params.get('task_type') == k %}
            <option value="{{k}}" selected="selected">{{name}}</option>
            {% else %}
            <option value="{{k}}">{{name}}</option>
            {% end %}
            {% end %}
          </select>
        </div>
        <h4 class="col-sm-2 control-label">任务状态</h4>
        <div class="col-sm-10">
          <select class="form-control status">
            <option value=""></option>
            {% for k,v in handler.task_statuses.items() %}
            {% if params.get('status') and params.get('status') == k %}
            <option value="{{k}}" selected="selected">{{v}}</option>
            {% else %}
            <option value="{{k}}">{{v}}</option>
            {% end %}
            {% end %}
          </select>
        </div>
        <h4 class="col-sm-2 control-label">领取人</h4>
        <div class="col-sm-10">
          <select class="form-control picked_user_id">
            <option></option>
          </select>
        </div>
        <h4 class="col-sm-2 control-label">发布时间</h4>
        <div class="col-sm-10 publish_time">
          <input type="text" class="form-control flatpickr publish_start" value="{{params.get('publish_start') or ''}}" data-enable-time=true data-enable-seconds=true placeholder="请选择开始时间"
                 style="float: left;width: 45%">
          <span style="margin-left: 4%; line-height: 25px">~</span>
          <input type="text" class="form-control flatpickr publish_end" value="{{params.get('publish_end') or ''}}" data-enable-time=true data-enable-seconds=true placeholder="请选择结束时间"
                 style="float: right;width: 45%">
        </div>
        <h4 class="col-sm-2 control-label">领取时间</h4>
        <div class="col-sm-10 picked_time">
          <input type="text" class="form-control flatpickr picked_start" value="{{params.get('picked_start') or ''}}" data-enable-time=true data-enable-seconds=true placeholder="请选择开始时间"
                 style="float: left;width: 45%">
          <span style="margin-left: 4%; line-height: 25px">~</span>
          <input type="text" class="form-control flatpickr picked_end" value="{{params.get('picked_end') or ''}}" data-enable-time=true data-enable-seconds=true placeholder="请选择结束时间"
                 style="float: right;width: 45%">
        </div>
        <h4 class="col-sm-2 control-label">完成时间</h4>
        <div class="col-sm-10 finished_time">
          <input type="text" class="form-control flatpickr finished_start" value="{{params.get('finished_start') or ''}}" data-enable-time=true data-enable-seconds=true placeholder="请选择开始时间"
                 style="float: left;width: 45%">
          <span style="margin-left: 4%; line-height: 25px">~</span>
          <input type="text" class="form-control flatpickr finished_end" value="{{params.get('finished_end') or ''}}" data-enable-time=true data-enable-seconds=true placeholder="请选择结束时间"
                 style="float: right;width: 45%">
        </div>
        <h4 class="col-sm-2 control-label">备注</h4>
        <div class="col-sm-10">
          <input type="text" class="form-control remark" value="{{params.get('remark') or ''}}" placeholder="请输入备注">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default waves-effect reset">重置</button>
        <button type="button" class="btn btn-default waves-effect" data-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary waves-effect waves-light modal-confirm">确定</button>
      </div>
    </div>
  </div>
</div>
<div id="publishModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="publishModal" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h4 class="modal-title">发布任务</h4>
      </div>
      <div class="modal-body">
        <input class="task_type" type="hidden" value="">
        <h4 class="control-label">任务批次</h4>
        <div>
          <input type="text" class="form-control batch" placeholder="请输入批次号">
        </div>
        <h4 class="control-label">选择前置任务</h4>
        <div class="pre_tasks">
          {% for t, v in handler.task_types.items() %}
          {% if handler.is_mod_enabled(v['name']) %}
          <label class="checkbox-inline">
            <input type="checkbox" class="{{t}}" title="{{t}}">{{v['name']}}
          </label>
          {% end %}
          {% end %}
        </div>
        <h4 class="control-label">选择子步骤</h4>
        <div class="steps">
        </div>
        <h4 class="control-label">选择优先级</h4>
        <div class="priority">
          <input type="radio" name="priority" value="3" style="margin-right: 10px">高
          <input type="radio" name="priority" value="2" style="margin: 0 10px" checked>中
          <input type="radio" name="priority" value="1" style="margin: 0 10px">低
        </div>
        <h4 class="control-label">任务已完成时，是否重新发布？</h4>
        <div class="force">
          <input type="radio" name="force" value="否" style="margin: 0 10px 0 0" checked>否
          <input type="radio" name="force" value="是" style="margin: 0 10px">是
        </div>
        <div class="modal-tab">
          <h4 class="control-label">选择待发布的任务</h4>
          <ul class="nav nav-tabs" id="tabContent">
            <li class="active"><a id="select-ids" href="#source-select" data-toggle="tab">逐个选择编码</a></li>
            <li><a href="#source-prefix" data-toggle="tab">按编码前缀</a></li>
            <li><a href="#source-file" data-toggle="tab">上传编码文件</a></li>
          </ul>
          <div class="tab-content">
            <div class="tab-pane active" id="source-select">
              <div class="form-group">
                <div>
                  <div class="ms-container my-container">
                    <div class="ms-selectable">
                      <div class="selectableHeader">待选对象<a href="javascript:void(0);" class="right_btn" id="select_all_btn">全选</a></div>
                      <div><i class="ser-btn"></i>
                        <input type="text" class="form-control search-input" id="selectable_input" placeholder="请输入关键字，回车可进行搜索">
                      </div>
                    </div>
                    <div class="ms-selection">
                      <div class="selectionHeader">已选对象<a href="javascript:void(0);" class="right_btn" id="deselect_all_btn">全删</a></div>
                      <div><input type="text" class="form-control search-input" id="selected_input" placeholder="请输入关键字，自动搜索已选对象"></div>
                    </div>
                  </div>
                  <select name="my-select[]" style="width:500px; display:none;" class="multi-select" multiple="multiple" id="my_multi_select">
                    <option value=""></option>
                  </select>
                  <div id="pagination" class="ms-search-pagination"></div>
                </div>
              </div>
            </div>
            <div class="tab-pane" id="source-prefix">
              <input type="text" class="form-control" id="id_prefix" placeholder="请输入编码前缀，如GL_2"/>
            </div>
            <div class="tab-pane" id="source-file">
              <i>请选择CSV、TXT或JSON格式的文件，大小不超过10M</i>
              <input type="file" class="form-control" id="upload" accept=".txt,.csv" style="padding:4px 4px"/>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default waves-effect" data-dismiss="modal">取消</button>
        <button type="button" class="btn btn-default waves-effect waves-light modal-refresh">确定</button>
        <button type="button" class="btn btn-primary waves-effect waves-light modal-confirm">发布</button>
      </div>
    </div>
  </div>
</div>
<div id="publishResultModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="publishResultModal"
     aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content" style="margin: 0 10px">
      <div>
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h4 class="modal-title">发布结果</h4>
      </div>
      <div class="modal-body">
        <table class="table">
        </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default waves-effect waves-light" data-dismiss="modal">继续发布</button>
        <button type="button" class="btn btn-primary waves-effect waves-light modal-confirm">查看结果</button>
      </div>
    </div>
  </div>
</div>
<div id="assignModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="assignModal" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content" style="width: 400px; margin: auto">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h4 class="modal-title">选择用户</h4>
      </div>
      <div class="modal-body">
        <div style="min-height: 150px; text-align: center">
          <select class="form-control select-user">
            <option></option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default waves-effect" data-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary waves-effect waves-light modal-confirm">指派</button>
      </div>
    </div>
  </div>
</div>
<div id="assignResultModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="assignResultModal"
     aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div>
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h4 class="modal-title">指派结果</h4>
      </div>
      <div class="modal-body">
        <table class="table">
        </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default waves-effect" data-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary waves-effect waves-light modal-confirm">确定</button>
      </div>
    </div>
  </div>
</div>
{% end %}

{% block custom-js %}
<script src="{{static_url('js/l10n.js')}}"></script>
<script src="{{static_url('assets/select2/select2.min.js')}}"></script>
<script src="{{static_url('assets/select2/zh-CN.js')}}"></script>
<script src="{{static_url('assets/jquery-multi-select/jquery.multi-select.js')}}"></script>
<script src="{{static_url('assets/jquery-multi-select/jquery.quicksearch.js')}}"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh.js"></script>
<script>
  /*---公共设置---*/
  var taskTypes = decodeJSON('{{handler.task_types}}');
  $.fn.modal.Constructor.prototype.enforceFocus = function () {
  };
</script>
<script>
  /*---普通操作---*/
  // 批量更新批次
  var $batchModal = $('#batchModal');
  $batchModal.find('.modal-confirm').click(function () {
    var ids = $.map($('.sty-table :checked'), function (item) {
      return $(item).parent().parent().attr('id');
    });
    if (!ids.length) {
      $batchModal.modal('hide');
      return showError('请选择任务');
    }
    var batch = $batchModal.find('.batch').val();
    if (!batch.length) {
      return showError('请输入批次');
    }
    postApi('/task/batch', {data: {'_ids': ids, 'batch': batch}}, function (res) {
      location.reload();
    });
  });
  // 统计检索结果
  $('.operation .btn-statistic a').click(function () {
    location.href = '/task/page/statistic?kind=' + $(this).attr('title') + location.search.replace('?', '&');
  });
  // 显示退回理由、失败理由等
  $('.sty-table td.return_reason').click(function () {
    if ($(this).text().length) {
      showTips($(this).text());
    }
  });
  // 查看页面
  $('.sty-table td.doc_id').click(function () {
    if ($(this).text().length) {
      location.href = '/data/page/' + $(this).text() + '?from=' + encodeFrom();
    }
  });
  // 浏览任务
  $('.sty-table .action .btn-nav').click(function () {
    var node = $(this).parent().parent();
    var taskType = node.find('.task_type').attr('title');
    location.href = '/task/browse/' + taskType + '/' + node.attr('id') + '?from=' + encodeFrom();
  });
  // 任务详情
  $('.sty-table .action .btn-detail').click(function () {
    var node = $(this).parent().parent();
    location.href = '/task/detail/' + node.attr('id');
  });
  // 任务历程
  $('.sty-table .action .btn-history').click(function () {
    var node = $(this).parent().parent();
    location.href = '/task/resume/page/' + node.find('.doc_id').text();
  });
  // 重新发布任务
  $('.sty-table .action .btn-republish').click(function () {
    var node = $(this).parent().parent();
    var regex = /(picked|failed)/i;
    if (!node.find('.status').attr('title').match(regex)) {
      return showWarning('状态有误', '只能重新发布进行中或已失败的任务！');
    }
    showConfirm("确定重新发布吗？", "任务" + node.find('.doc_id').text().trim() + "将被重新发布！", function () {
      postApi('/task/republish/' + node.attr('id'), {data: {}}, function () {
        window.location.reload();
      });
    });
  });
  $('.sty-table .action .btn-delete').click(function () {
    var node = $(this).parent().parent();
    var regex = /(published|pending|returned)/i;
    if (!node.find('.status').attr('title').match(regex)) {
      return showWarning('状态有误', '只能删除已发布未领取、等待前置任务、已退回的任务！');
    }
    var id = node.attr('id');
    var data = getData(id);
    var name = 'name' in data ? data.name : '';
    showConfirm("确定删除" + name + "吗？", "删除后无法恢复！", function () {
      postApi('/task/delete', {data: {_id: data._id}}, function (res) {
        showSuccess('成功', '数据' + name + '已删除');
        refresh(1000);
      }, function (err) {
        showError('删除失败', err.message);
      });
    });
  });
</script>
<script>
  /*---指派任务---*/
  var $assignModal = $('#assignModal');
  var $assignResultModal = $('#assignResultModal');
  $assignModal.find(".select-user").select2({
    dropdownParent: $assignModal,
    ajax: {
      type: 'POST', url: '/api/user/list', dataType: 'json', delay: 1000, language: 'zh-CN',
      allowClear: true, width: "100%", placeholder: "请选择", maximumSelectionLength: 2,
      data: function (params) {
        return {'q': params.term, 'page': params.page || 1};
      },
      processResults: function (res) {
        return res.data;
      }
    }
  });
  $assignModal.find('.modal-confirm').click(function () {
    if (!$('.sty-table :checked').length) {
      $assignModal.modal('hide');
      return showError('请选择任务');
    }
    var tasks = $.map($('table tbody :checked'), function (item) {
      var node = $(item).parent().parent();
      return [[node.attr('id'), node.find('.task_type').attr('title'), node.find('.doc_id').text()]];
    });
    var data = {'tasks': tasks, 'user_id': $assignModal.find(".select-user").val()};
    postApi('/task/assign', {'data': data}, function (res) {
      var html = $.map(res.data, function (value, key) {
        return '<tr><td class="' + key + '">' + l10n[key] + '(' + value.length + ')' + '<td>' + value + '</td>' + '</td></tr>';
      }).join('');
      $assignModal.modal('hide');
      $assignResultModal.find('table').html(html);
      $assignResultModal.modal();
    });
  });
  $assignResultModal.find('.modal-confirm').click(function () {
    location.reload();
  });

</script>
<script>
  /*---综合检索---*/
  var $searchModal = $("#searchModal");
  var searchFields = [
    {id: 'batch'}, {id: 'doc_id'}, {id: 'status', input_type: 'select'}, {id: 'task_type', input_type: 'select'},
    {id: 'picked_user_id', input_type: 'select'}, {id: 'publish_start'}, {id: 'publish_end'},
    {id: 'picked_start'}, {id: 'picked_end'}, {id: 'finished_start'}, {id: 'finished_end'},
    {id: 'remark'}
  ];
  // 设置时间选择器
  $("#searchModal .publish_start").flatpickr({allowInput: true, locale: 'zh', time_24hr: true});
  $("#searchModal .publish_end").flatpickr({allowInput: true, locale: 'zh', time_24hr: true});
  $("#searchModal .picked_start").flatpickr({allowInput: true, locale: 'zh', time_24hr: true});
  $("#searchModal .picked_end").flatpickr({allowInput: true, locale: 'zh', time_24hr: true});
  $("#searchModal .finished_start").flatpickr({allowInput: true, locale: 'zh', time_24hr: true});
  $("#searchModal .finished_end").flatpickr({allowInput: true, locale: 'zh', time_24hr: true});
  // 设置领取人
  $searchModal.find('.picked_user_id').select2({
    dropdownParent: $searchModal,
    ajax: {
      type: 'POST', url: "/api/user/list", dataType: 'json', delay: 1000, language: 'zh-CN',
      allowClear: true, width: "100%", placeholder: "请选择", maximumSelectionLength: 2,
      data: function (params) {
        return {'q': params.term, 'page': params.page || 1};
      },
      processResults: function (res) {
        return res.data;
      }
    }
  });
  // 提交
  $searchModal.find('.modal-confirm').click(function () {
    var data = getModal($searchModal, searchFields);
    var search = $.map(data, function (v, k) {
      return '&' + k + '=' + v;
    }).join('');
    if (!search.length)
      return showWarning('请输入查询条件');
    location.href = location.pathname + '?' + search.substr(1);
  });
  // 重置
  $searchModal.find('.reset').click(function () {
    $searchModal.find('.picked_user_id').val(null).trigger('change');
    resetModal($searchModal, searchFields);
  });
</script>
{% end %}