<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <title>注册</title>
  {% include _base_css.html %}
  <link href="{{static_url('assets/ionicons/css/ionicons.min.css')}}" rel="stylesheet">
  <link rel="stylesheet" href="{{static_url('css/register.css')}}">
</head>

<body>
<div class="app-main">
  <div class="main">
    <div class="register">
      <form>
        <div class="register-in">
          <div class="hd clearfix">
            <h3 class="logo fl"></h3>
            <span class="desc fr">已有账号？点我&nbsp;<em><a href="/user/login?next={{next}}" class="login_a">登录</a></em></span>
          </div>
          <div class="bd">
            <div class="item">
              <input type="text" placeholder='请输入姓名' id="name">
              <i class="icon-user"></i>
            </div>
            <div class="item">
              <div class="select-wrap">
                <select id="gender">
                  <option disabled selected style='display:none;'>请选择性别</option>
                  <option value="男">男</option>
                  <option value="女">女</option>
                </select>
              </div>
              <i class="icon-gender"></i>
            </div>
            <div class="item">
              <input type="password" placeholder='请输入密码' id="password">
              <i class="icon-lock"></i>
              <span class="hide"></span>
            </div>
            <div class="item">
              <input type="password" placeholder='请再次输入密码' id="confirm_psw">
              <i class="icon-lock-open"></i>
            </div>
            <div class="item">
              <input type="number" placeholder='请输入手机号' id="phone">
              <i class="icon-phone"></i>
            </div>
            <div class="item">
              <input type="text" placeholder='请输入邮箱' id="email">
              <i class="icon-mail"></i>
            </div>
            <div class="verify">
              <div class="item hide fl" id="phone-div">
                <input type="text" placeholder='请输入验证码' id="phone-code">
                <i class="icon-check-outline"></i>
                <a id="phone-code-btn" class="verify-code phone-code-btn">获取验证码</a>
              </div>
              <div class="item hide fr" id="email-div">
                <input type="text" placeholder='请输入验证码，可能在垃圾邮箱' id="email-code">
                <i class="icon-check-outline"></i>
                <a id="email-code-btn" class="verify-code email-code-btn">获取验证码</a>
              </div>
            </div>
          </div>
          <div class="error"><p class="ajax-error" style="display: none"></p></div>
          <div class="tips">注：手机号和邮箱任选一个</div>
          <div class="register-agreement">
            <input type="checkbox" class="inp" style="margin-right: 5px"/>
            <span>同意<a href="#">《网站注册协议》</a></span>
          </div>
          <div class="register-btn">
            <a href="#">注&nbsp;&nbsp;&nbsp;&nbsp;册</a>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
{% include _base_footer.html %}
{% include _base_js.html %}

<script>

  $("#phone").on('input propertychange', function () {
    var input = $(this).val().trim();
    if (input.length === 0) {
      $('#phone-div').addClass('hide');
    } else {
      $('#phone-div').removeClass('hide');
    }
  });

  $("#email").on('input propertychange', function () {
    var input = $(this).val().trim();
    if (input.length === 0) {
      $('#email-div').addClass('hide');
    } else {
      $('#email-div').removeClass('hide');
    }
  });

  $('.register-btn > a').click(function () {
    var password = $('#password').val();
    var confirm_psw = $('#confirm_psw').val();
    if (password !== confirm_psw) {
      return showError('密码错误', '两次输入的密码不一致。');
    }
    postApi('/user/register?next={{next}}', {
      data: {
        name: $('#name').val(),
        gender: $('#gender').val(),
        email: $('#email').val(),
        email_code: $('#email-code').val(),
        phone_code: $('#phone-code').val(),
        password: password,
        phone: $('#phone').val()
      }
    }, function (data) {
      window.location = data.redirect || '{{next}}';
    }, function (error) {
      return showError('提交失败', error.message);
    });
  });

  $("#email-code-btn").click(function () {
    var email = $('#email').val().trim();
    if (email.length === 0) {
      return showError('邮箱不能为空', '请输入注册邮箱');
    }
    var mailReg = /^(\w-*\.*)+@(\w-?)+(\.\w{2,})+$/;
    if (!mailReg.test(email)) {
      return showError('邮箱格式不正确', '邮箱格式不正确');
    }
    if ($(this).hasClass('sending')) {  // 判断是否已经发送
      return;
    }
    var $this = $(this);
    $this.text("发送中...");
    postApi('/user/email_code', {'data': {email: email}}, function (res) {
      if (!res.status) {
        return showError(code, error);
      } else {
        $this.addClass('sending');      // 成功后显示已发送状态
        var time = 60;
        var interval = setInterval(function () {
          $this.text("已发送(" + time + ")");
          time -= 1;
          if (time <= 0) {
            clearInterval(interval);
            $this.removeClass('sending');
            $this.text("获取验证码");
          }
        }, 1000);
      }
    });
  });

  $("#phone-code-btn").click(function () {
    var phone = $('#phone').val().trim();
    if (phone.length === 0) {
      return showError('手机号不能为空', '请输入手机号码');
    }
    var phoneReg = /^1[3-578]\d{9}$/;
    if (!phoneReg.test(phone)) {
      return showError('手机号格式不正确', '手机号格式不正确');
    }
    if ($(this).hasClass('sending')) {  // 判断是否已经发送
      return;
    }
    var $this = $(this);
    $this.text("发送中...");
    postApi('/user/phone_code', {'data': {phone: phone}}, function (res) {
      if (!res.status) {
        return showError(code, error);
      } else {
        $this.addClass('sending');      // 成功后显示已发送状态
        var time = 60;
        var interval = setInterval(function () {
          $this.text("已发送(" + time + ")");
          time -= 1;
          if (time <= 0) {
            clearInterval(interval);
            $this.removeClass('sending');
            $this.text("获取验证码");
          }
        }, 1000);
      }
    });
  });

</script>
</body>
</html>
