<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>{{handler.page_title()}}</title>
  {% include _base_css.html %}
  <link href="{{static_url('assets/modal-effect/css/component.css')}}" rel="stylesheet">
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
  <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
  <![endif]-->
  {% block custom-css %}
  {% end %}
</head>

<body class="widescreen">
<div class="app-main">
  <div class="main">
    <div class="m-header">
      <div class="left">
        <div class="btn-group back">
          {% set title, img = ('任务大厅', 'icon_lobby') if handler.mode == 'do' else ('返回', 'icon_back') %}
          <img src="{{static_url('imgs/%s.png' % img)}}" class="btn-img" onclick="leave()" title="{{title}}"/>
        </div>
        <div class="btn-group title" title="{{handler.page['name']}}">
          {{handler.task_name()}}
          <span class="sub-title {{'' if handler.step_name() else 'hide'}}">-{{handler.step_name()}}</span>
        </div>
      </div><!--left-->
      <div class="center">
        {% block buttons %}
        {% end %}
      </div>
      <div class="right">
        <img src="{{static_url('imgs/icon_config.png')}}" class="btn-img {{'' if handler.mode == 'do' else 'hide'}}" data-toggle="modal" data-target="#autoPickModal" title="自动领任务"/>
        <img src="{{static_url('imgs/icon_prev.png')}}" class="btn-img {{'hide' if handler.steps.get('is_first') else ''}}" id="prev-step" title="上一步"/>
        <img src="{{static_url('imgs/icon_return.png')}}" class="btn-img {{'' if not handler.readonly else 'hide'}}" data-toggle="modal" data-target="#returnModal" title="退回"/>
        <img src="{{static_url('imgs/icon_save.png')}}" class="btn-img {{'hide' if handler.readonly else ''}}" id="save-task" title="保存"/>
        <img src="{{static_url('imgs/icon_next.png')}}" class="btn-img {{'hide' if handler.steps.get('is_last') else ''}}" id="next-step" title="下一步"/>
        <img src="{{static_url('imgs/icon_submit.png')}}" class="btn-img {{'' if handler.steps.get('is_last') and not handler.readonly else 'hide'}}" id="submit-task" title="提交"/>
        {% if handler.mode == 'browse' %}
        <div class="btn-txt btn-gap"></div>
        <img src="{{static_url('imgs/icon_view.png')}}" class="btn-img" id="view-page" title="查看页面"/>
        <img src="{{static_url('imgs/icon_remark.png')}}" class="btn-img" data-toggle="modal" data-target="#remarkModal" title="备注"/>
        <img src="{{static_url('imgs/icon_prev2.png')}}" class="btn-img" id="prev-task" title="前一个任务"/>
        <img src="{{static_url('imgs/icon_next2.png')}}" class="btn-img" id="next-task" title="后一个任务"/>
        {% end %}
      </div><!--right-->
    </div>
    <div class="full-bd flex-content pfread">
      {% block full-bd %}
      {% end %}
    </div>
  </div>
</div>

<div class="panel-body" style="padding: 0">
  {% module ReturnModal() %}
  {% module AutoPickModal() %}
  {% module TaskRemarkModal() %}
  {% block custom-modal %}
  {% end %}
</div>

{% include _base_js.html %}
<script>
  // 任务类型，放在pick-task.js之前
  var taskType = '{{handler.task_type}}';
  var lobbyTaskType = taskType.replace(/text_proof_\d/, 'text_proof');
</script>
<script src="{{static_url('js/pick-task.js')}}"></script>
<script>
  var from = decodeFrom();
  var mode = '{{handler.mode}}';
  var docId = '{{handler.doc_id}}';
  var taskId = '{{handler.task_id}}';
  var steps = decodeJSON('{{handler.steps}}');
  var readonly = '{{handler.readonly}}' === 'True';
  var isSample = '{{handler.task.get("is_sample")}}';
  var step = '{{handler.steps.get("current") or ""}}';
  var remark = '{{handler.task.get("remark") or ""}}';

  $(document).ready(function () {
    // 初始化设置备注、是否自动领任务、是否为示例任务
    $("#remarkModal .remark").val(remark || localStorage.getItem('taskRemark'));
    var autoPick = localStorage.getItem('autoPick') || '是';
    if (autoPick.length) {
      $('#autoPickModal .auto-pick :radio[value=' + autoPick + ']').prop('checked', true);
    }
    if (isSample === 'True') {
      $('#remarkModal .is_sample :radio[value="是"]').prop('checked', true);
    } else if (isSample === 'False') {
      $('#remarkModal .is_sample :radio[value="否"]').prop('checked', true);
    }
  });

  // 离开页面
  window.leave = function () {
    // 释放临时数据锁
    if (['edit', 'update'].indexOf(mode) !== -1 && !readonly) {
      if (taskType.indexOf('cut_') !== -1) {
        postApi('/data/unlock/box/' + docId, {});
      } else if (taskType.indexOf('text_') !== -1) {
        postApi('/data/unlock/text/' + docId, {});
      }
    }
    // 返回
    if (from) {
      window.location = from;
    } else if (mode === 'do') {
      window.location = '/task/lobby/' + lobbyTaskType;
    } else if (mode === 'update') {
      window.location = '/task/my/' + lobbyTaskType;
    } else {
      window.history.back();
    }
  };

  // 步骤导航
  function navigate(to) {
    var url = location.pathname + '?step=' + steps[to];
    if (from)
      url = url + '&from=' + from;
    if (!readonly) {
      saveTask(to === 'next', url);
    } else {
      goto(url, 500);
    }
  }

  // 上一步
  $(document).on("click", '#prev-step', function () {
    navigate('prev');
  });

  // 下一步
  $(document).on("click", '#next-step', function () {
    navigate('next');
  });

  // 完成任务提交
  $(document).on("click", '#submit-task', function () {
    var data = getSubmitData(true);
    var autoPick = localStorage.getItem('autoPick') || '是';
    if (data && !data.error) {
      showTips('提交中‧‧‧');
      postApi(location.pathname, {data: data}, function () {
        showSuccess('成功', '已提交');
        setTimeout(function () {
          if (mode === 'do' && autoPick === '是') {
            pick('/task/pick/' + lobbyTaskType);
          } else {
            window.leave();
          }
        }, 1000);
      });
    }
  });

  // 保存任务
  function saveTask(submit, url) {
    var data = getSubmitData(submit);
    if (data && !data.error) {
      showTips('保存中‧‧‧');
      postApi(location.pathname, {data: data}, function () {
        if (!submit)
          showSuccess('成功', '已保存');
        goto(url, 1000);
      });
    }
  }

  // 保存任务提交
  $(document).on("click", '#save-task', function () {
    var search = location.search;
    // 字序校对保存后，刷新的url中删除layout参数
    if (step === 'orders') {
      search = deleteQueryString(location.search, 'layout');
    }
    saveTask(false, location.pathname + search);
  });

  // 退回任务提交
  $(document).on('click', '#returnModal .modal-confirm', function () {
    var reason = $('#returnModal .return_reason').val().trim();
    if (!reason.length) {
      return showError('请填写退回理由', '尚未填写退回理由');
    }
    postApi('/task/return/' + taskId, {data: {reason: reason}}, function () {
      showSuccess('退回成功', docId + ' 已退回成功。');
      goto('/task/lobby/' + taskType, 1000);
    });
  });

  // 查看页面
  $(document).on("click", '#view-page', function () {
    location.href = '/data/page/' + docId + '?from=' + encodeFrom();
  });

  // 浏览任务
  function browse(to) {
    var path = '/task/browse/' + taskType + '/' + taskId;
    location.href = path + setQueryString('to', to, true);
  }

  // 前一个任务
  $(document).on("click", '#prev-task', function () {
    browse('prev');
  });

  // 后一个任务
  $(document).on("click", '#next-task', function () {
    browse('next');
  });

  // 备注任务
  var $remarkModal = $('#remarkModal');
  $remarkModal.find('.options :radio').click(function () {
    $('#remarkModal .remark').val($(this).val());
  });
  $remarkModal.find('.modal-confirm').click(function () {
    var remark = $('#remarkModal .remark').val().trim();
    if (!remark.length)
      return showWarning('请输入备注内容');
    localStorage.setItem('taskRemark', remark);
    var data = {_id: taskId, remark: remark};
    var is_sample = $('#remarkModal .is_sample :checked').val();
    if (typeof is_sample !== 'undefined')
      data.is_sample = is_sample;
    postApi('/task/remark', {data: data}, function () {
      showSuccess('成功', '已备注');
      navigate(getQueryString('to') || 'next');
    });
  });

  // 是否自动领取新任务
  $('#autoPickModal .modal-confirm').click(function () {
    var autoPick = $('#autoPickModal .auto-pick :checked');
    if (!autoPick.length)
      return showWarning('请进行选择');
    localStorage.setItem('autoPick', autoPick.val());
    $('#autoPickModal').modal('hide');
  });

</script>
{% block custom-js %}
{% end %}
<script src="{{static_url('js/nav.js')}}"></script>
</body>
</html>
