<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>藏经OCR</title>
  {% include _base_meta.html %}
  {% include _base_css.html %}
  <link href="{{ static_url('css/helper.css') }}" rel="stylesheet" type="text/css"/>
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
  <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
  <![endif]-->
  <style>
    .content {
      width: 820px;
      margin: 45px auto;
    }

    .content .title {
      font-size: 1.2em;
      margin: 10px 0;
    }

    .list li {
      float: left;
      box-sizing: border-box;
      text-align: center;
    }

    .list li:nth-child(2n+2) {
      margin-right: 0;
      float: right;
    }

    .list p {
      line-height: 42px;
      position: relative;
    }

    .list label {
      color: #13171c;
      font-size: 16px;
      font-weight: normal;
    }

    form input[type='file'] {
      padding: 6px 4px;
      font-size: 12px;
    }

  </style>

</head>

<body class="widescreen">
<div class="app-main">
  <div class="main">
    <div class="m-header">
      <div class="back">
        <a href="/">
          <img src="{{ static_url('imgs/home.png') }}" class="btn-img"/>
        </a>
      </div>
      <div class="title">藏经OCR</div>
      <div class="right" style="margin: 2px 8px">
        <img src="{{ static_url('imgs/loading.gif') }}" class="btn-img hide" id="progress" title="进行中" style="margin: 6px 6px;"/>
        <button type="button" class="btn btn-primary" id="btn-submit">进行识别</button>
      </div>
    </div>

    <div class="content">
      <div class="title">第一步：选择文件</div>
      <form id="uploadform" enctype="multipart/form-data">
        <i>选择藏经图片文件，大小不超过1MB</i><br/>
        <input type="file" class="form-control" id="upload" name="img" accept="image/*">
      </form>
      <div class="title">第二步：选择版面</div>
      <div id="layout">
        <ul class="list clearfix">
          <li>
            <img src="{{ static_url('imgs/ocr/vertical_1.jpg') }}"/>
            <p>
              <input type="radio" id="layout1" name="drone" value="vertical_1" checked>
              <label for="layout1">上下一栏</label>
            </p>
          </li>
          <li>
            <img src="{{ static_url('imgs/ocr/horizontal_2.jpg') }}"/>
            <p>
              <input type="radio" id="layout0" name="drone" value="horizontal_2">
              <label for="layout0">左右两栏</label>
            </p>
          </li>
          <li>
            <img src="{{ static_url('imgs/ocr/vertical_2.jpg') }}"/>
            <p>
              <input type="radio" id="layout2" name="drone" value="vertical_2">
              <label for="layout2">上下两栏</label>
            </p>
          </li>
          <li>
            <img src="{{ static_url('imgs/ocr/vertical_3.jpg') }}"/>
            <p>
              <input type="radio" id="layout3" name="drone" value="vertical_3">
              <label for="layout3">上下三栏</label>
            </p>
          </li>
        </ul>
      </div>
    </div>
  </div>

</div>

{% include _base_js.html %}

<script>
  $("#btn-submit").click(function () {
    if (typeof $('#upload')[0].files[0] == "undefined") {
      return showError('请选择图片');
    }
    var imgFile = $('#upload')[0].files[0];
    var imgStr = /\.(jpg|jpeg|png|bmp|tif|tiff|gif)$/i;
    if (!imgStr.test(imgFile.name)) {
      return showError('文件不是图片类型');
    }
    if (imgFile.size > (10 * 1024 * 1024)) {
      return showError('文件大小不能超过10M');
    }
    $('#progress').removeClass('hide');
    var layout = $('#layout input:radio:checked').val();
    var layout2num = {
      "horizontal_2": [1, 1],
      "vertical_1": [1, 1],
      "vertical_2": [3, 2],
      "vertical_3": [4, 2]
    };
    var formData = new FormData();
    formData.append('img', imgFile);
    $.ajax({
      url: '/api/data/ocr?h_num=' + layout2num[layout][0] + '&v_num=' + layout2num[layout][1],
      type: 'POST',
      data: formData,
      processData: false,
      contentType: false,
      success: function (r) {
        if (r.error) {
          showError('上传失败', r.message);
        } else if (r.data.name) {
          // showSuccess('识别完成', r.data.name + ' 已识别完成。');
          window.location = '/data/ocr/' + r.data.name;
        }
        $('#progress').addClass('hide');
      }
    });
  });

</script>

</body>

</html>
