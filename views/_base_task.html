<script src="{{ static_url('js/pick-task.js') }}"></script>
<script>
  var from = decodeFrom();
  var mode = '{{handler.mode}}';
  var readonly = '{{handler.readonly}}' === 'True';
  var pageName = '{{handler.page.get("name") or ""}}';
  var oriTaskType = '{{handler.task_type}}';
  var taskId = '{{handler.task.get("_id") or ""}}';
  var taskType = oriTaskType.indexOf('text_proof') !== -1 ? 'text_proof' : oriTaskType;

  $(document).ready(function () {
    var taskRemark = '{{handler.task.get("remark") or ""}}';
    $("#remarkModal .remark").val(taskRemark || localStorage.getItem('taskRemark'));
  });

  // 离开页面
  window.leave = function () {
    // 释放临时数据锁
    if (mode in ["edit", "update"] && !readonly) {
      if (taskType.indexOf("cut") !== -1)
        postApi('/data/unlock/box/' + pageName, {});
      else if (taskType.indexOf("text") !== -1)
        postApi('/data/unlock/text/' + pageName, {});
    }
    // 返回
    if (from) {
      window.location = from;
    } else if (mode === 'do') {
      window.location = '/task/lobby/' + taskType;
    } else if (mode === 'update') {
      window.location = '/task/my/' + taskType;
    } else {
      window.history.back();
    }
  };

  // 保存任务函数
  function saveTask(submit, url) {
    var data = getSubmitData(submit);
    if (data && !data.error) {
      showTips('保存中‧‧‧');
      postApi('{{current_path}}', {data: data}, function () {
        if (!submit)
          showSuccess('保存成功', pageName + ' 已保存成功');
        goto(url, 1000);
      });
    }
  }

  // 提交任务
  $(document).on("click", '#submit-task', function () {
    var data = getSubmitData(true);
    if (data && !data.error) {
      showTips('提交中‧‧‧');
      postApi('{{current_path}}', {data: data}, function () {
        showSuccess('成功', '已提交。');
        setTimeout(function () {
          if (mode === 'do') {
            pick('/task/pick/' + taskType);
          } else {
            window.leave();
          }
        }, 1000);
      });
    }
  });

  // 上一步
  $(document).on("click", '#prev-step', function () {
    var prev = '{{"%s?step=%s" % (current_path, handler.steps.get("prev"))}}';
    var url = from ? prev + '&from=' + from : prev;
    if (!readonly) {
      saveTask(false, url);
    } else {
      goto(url, 500);
    }
  });

  // 下一步
  $(document).on("click", '#next-step', function () {
    var next = '{{"%s?step=%s" % (current_path, handler.steps.get("next"))}}';
    var url = from ? next + '&from=' + from : next;
    if (!readonly) {
      saveTask(true, url);
    } else {
      goto(url, 500);
    }
  });

  // 保存任务
  $(document).on("click", '#save-task', function () {
    var search = location.search;
    if ('{{handler.steps["current"]}}' === 'orders')
      search = deleteQueryString(location.search, 'layout');
    saveTask(false, location.pathname + search);
  });

  // 退回任务
  $(document).on('click', '#returnModal .modal-confirm', function () {
    var reason = $('#returnModal .return_reason').val().trim();
    if (!reason.length) {
      return showError('请填写退回理由', '尚未填写退回理由');
    }
    postApi('/task/return/' + taskId, {data: {reason: reason}}, function () {
      showSuccess('退回成功', pageName + ' 已退回成功。');
      goto('/task/lobby/' + taskType, 1000);
    });
  });

  // 查看页面
  $(document).on("click", '#view-page', function () {
    location.href = '/data/page/' + pageName + '?from=' + encodeFrom();
  });

  // 浏览任务
  function go(to) {
    var path = '/task/browse/' + taskType + '/' + taskId;
    location.href = path + setQueryString('to', to, true);
  }

  // 前一个任务
  $(document).on("click", '#prev-task', function () {
    go('prev');
  });

  // 后一个任务
  $(document).on("click", '#next-task', function () {
    go('next');
  });

  // 备注任务
  $("#remarkModal .options :radio").click(function () {
    $('#remarkModal .remark').val($(this).val());
  });
  $('#remarkModal .modal-confirm').click(function () {
    var remark = $('#remarkModal .remark').val().trim();
    if (!remark.length)
      return showWarning('请输入备注内容');
    localStorage.setItem('taskRemark', remark);
    var data = {_id: taskId, remark: remark};
    postApi('/task/remark', {data: data}, function () {
      showSuccess('成功', pageName + ' 备注成功。');
      go(getQueryString('to') || 'next');
    });
  });
</script>

