<script src="{{ static_url('js/pick-task.js') }}"></script>
<script>
  // 上一步
  $(document).on("click", '#prev-step', function () {
    window.location = '{{"%s?step=%s" % (current_path, steps.get("prev"))}}';
  });

  // 下一步
  $(document).on("click", '#next-step', function () {
    if ('{{not readonly and mode != "view"}}' === 'True') {
      postApi('{{current_path}}', {data: getSubmitData(true)}, function () {
        window.location = '{{"%s?step=%s" % (current_path, steps.get("next"))}}';
      });
    } else {
      window.location = '{{"%s?step=%s" % (current_path, steps.get("next"))}}';
    }
  });

  // 保存任务
  $(document).on("click", '#save-task', function () {
    var data = getSubmitData(false);
    if (data)
      postApi('{{current_path}}', {data: data}, function () {
        showSuccess('保存成功', '{{page["name"]}} ' + '已保存成功');
        setTimeout(function () {
          window.location.reload();
        }, 1000);
      });
  });

  // 提交任务
  $(document).on("click", '#submit-task', function () {
    var data = getSubmitData(true);
    if (data)
      postApi('{{current_path}}', {data: getSubmitData(true)}, function () {
        showSuccess('成功', '已提交。');
        setTimeout(function () {
          if ('do' === '{{mode}}') {
            pick('/task/pick/{{task_type}}');
          } else {
            window.leave();
          }
        }, 1000);
      });
  });

  // 退回任务
  $(document).on('click', '#return-modal-confirm', function () {
    var reason = $('#return_reason').val().trim();
    if (!reason.length) {
      return showError('请填写退回理由', '尚未填写退回理由');
    }
    postApi('/task/return/{{task_type}}/{{task.get("_id")}}', {data: {reason: reason}}, function () {
      showSuccess('退回成功', '{{page["name"]}} ' + '已退回成功。');
      setTimeout(function () {
        var taskType = '{{"text_proof" if "text_proof" in task_type else task_type }}';
        window.location = '/task/lobby/' + taskType;
      }, 1000);
    });
  });

  // 离开页面
  window.leave = function () {
    // 释放临时数据锁
    if ('{{not readonly and "cut" in task_type and mode in ["edit", "update"]}}' === 'True') {
      postApi('/data/unlock/box/{{page["name"]}}', {});
    }
    if ('{{not readonly and "text" in task_type and mode in ["edit", "update"]}}' === 'True') {
      postApi('/data/unlock/text/{{page["name"]}}', {});
    }
    // 返回
    var taskType = '{{"text_proof" if "text_proof" in task_type else task_type }}';
    if ('{{mode}}' === 'do') {
      window.location = '/task/lobby/' + taskType;
    } else if ('{{mode}}' === 'update') {
      window.location = '/task/my/' + taskType;
    } else {
      window.history.back();
    }
  };
</script>

