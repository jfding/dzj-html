{% extends "_list.html" %}

{% block custom-css %}
<link href="{{static_url('css/task-admin.css')}}" rel="stylesheet"/>
<style>
  .swal2-label {
    font-size: 0.875em;
  }

  .char-img {
    width: 60px;
  }

  #searchModal .modal-body h4, #searchModal .modal-body div {
    margin: 5px 0;
  }
</style>
{% include _font_css.html %}
{% end %}

{% block custom-modal %}
<div id="helpModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="helpModal"
     aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h4 class="modal-title">帮助文档</h4>
      </div>
      <div class="modal-body">
        <div class="title">一、简介</div>
        <div class="intro">
          页数据管理模块提供各种的页面的管理操作，包括批量删除、查找重复、更新分类、综合检索、发布任务等，
          还可以针对具体的页面进行浏览、查看详情、更新基础数据、删除等操作。<br/>
          注：浏览指的是针对检索结果的浏览，浏览时可以对页面进行具体的操作。
        </div>
        <div class="title">二、操作</div>
        <table class="table">
          <tr>
            <td>批量删除</td>
            <td>批量删除选中的页面</td>
          </tr>
          <tr>
            <td>查找重复</td>
            <td>查找页编码重复的页面</td>
          </tr>
          <tr>
            <td>更新分类</td>
            <td>批量更新选中页面的分类。对页面分类后，以便进行管理</td>
          </tr>
          <tr>
            <td>综合检索</td>
            <td>
              可以对页面的各个字段进行检索。尤其值得注意的是，综合检索设置了“切分任务”、“文字任务”两种字段，包括“全未发布”、
              “已发布”、“全部完成”。比如要检索所有未发布切分任务的页面，就可以通过这个字段进行。
            </td>
          </tr>
          <tr>
            <td>发布任务</td>
            <td>
              如果任务没有前置任务，则系统直接发布为「已发布」。如果有前置任务，则根据前置任务情况：如果都已完成，则发布为「已发布」；
              如果有一个前置任务未完成，则发布为「等待前置任务」。<br/>
              该任务的前置任务在完成时，系统会进行检查，如果所有前置任务都已完成，则系统将自动设置为「已发布」。<br/>
              如果任务数据未就绪或已经发布，则发布失败。已退回的任务可以重新发布。
            </td>
          </tr>
          <tr>
            <td>浏览</td>
            <td>逐条浏览检索结果，在浏览页面时可以对页面进行各种操作</td>
          </tr>
          <tr>
            <td>详情</td>
            <td>查看页面详情</td>
          </tr>
          <tr>
            <td>更新</td>
            <td>更新页面基础信息</td>
          </tr>
          <tr>
            <td>删除</td>
            <td>删除页面</td>
          </tr>
        </table>
      </div>
    </div>
  </div>
</div>
<div id="searchModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="searchModal" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-body">
        <form class="form-horizontal">
          <div class="form-group">
            <h4 class="col-sm-2 control-label">字编码</h4>
            <div class="col-sm-10">
              <input type="text" class="form-control name" value="{{params.get('name') or ''}}" placeholder="请输入字编码，可部分输入">
            </div>
            <h4 class="col-sm-2 control-label">分　类</h4>
            <div class="col-sm-10">
              <input type="text" class="form-control source" value="{{params.get('source') or ''}}" placeholder="请输入分类">
            </div>
            <h4 class="col-sm-2 control-label">OCR文字</h4>
            <div class="col-sm-10">
              <input type="text" class="form-control ocr_txt" value="{{params.get('ocr_txt') or ''}}" placeholder="请输入OCR文字，一个汉字">
            </div>
            <h4 class="col-sm-2 control-label">校对文字</h4>
            <div class="col-sm-10">
              <input type="text" class="form-control txt" value="{{params.get('txt') or ''}}" placeholder="请输入校对文字，一个汉字">
            </div>
            <h4 class="col-sm-2 control-label">文字类型</h4>
            <div class="col-sm-10">
              <select class="form-control txt_type">
                <option value=""></option>
                {% for k,v in txt_types.items() %}
                {% if params.get('txt_type', '') == k %}
                <option value="{{k}}" selected="selected">{{v}}</option>
                {% else %}
                <option value="{{k}}">{{v}}</option>
                {% end %}
                {% end %}
              </select>
            </div>
            <h4 class="col-sm-2 control-label">置信度</h4>
            <div class="col-sm-10">
              <input type="text" class="form-control cc" value="{{params.get('cc') or ''}}" placeholder="请输入置信度，支持范围如>0.5、>=0.5、<0.9、<=0.9等，默认为等于">
            </div>
            <h4 class="col-sm-2 control-label">备　注</h4>
            <div class="col-sm-10">
              <input type="text" class="form-control remark" value="{{params.get('remark') or ''}}" placeholder="请输入备注">
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default waves-effect reset">重置</button>
        <button type="button" class="btn btn-default waves-effect" data-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary waves-effect waves-light modal-confirm">确定</button>
      </div>
    </div>
  </div>
</div>
<div id="publishModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="publishModal" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h4 class="modal-title">发布任务/<span id="task-name"></span></h4>
      </div>
      <div class="modal-body">
        <input class="task_type" type="hidden" value="">
        <h4 class="control-label">任务批次</h4>
        <div>
          <input type="text" class="form-control batch" placeholder="请输入批次号">
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-default waves-effect" data-dismiss="modal">取消</button>
      <button type="button" class="btn btn-default waves-effect waves-light modal-refresh">确定</button>
      <button type="button" class="btn btn-primary waves-effect waves-light modal-confirm">发布</button>
    </div>
  </div>
</div>
</div>
{% end %}

{% block custom-js %}
<script src="{{static_url('js/l10n.js')}}"></script>
<script>
  // 更新分类
  $('.operation .bat-source').click(function () {
    var ids = $.map($('table tbody :checked'), (item) => $(item).parent().parent().attr('id'));
    if (!ids.length)
      return showWarning('请选择', '当前没有选中任何记录。');
    Swal2.fire({title: '请输入分类', input: 'text', showLoaderOnConfirm: true}).then((result) => {
      if (result.value) {
        postApi('/data/char/source', {data: {_ids: ids, source: result.value}}, () => location.reload());
      }
    });
  });

  // 生成字图
  $('.operation .bat-gen-img').click(function () {
    var docCount = '{{pager["doc_count"]}}';
    var ids = $.map($('table tbody :checked'), (item) => $(item).parent().parent().attr('id'));
    var inputOptions = {selected: '选中记录(' + ids.length + ')', searched: '检索结果(' + docCount + ')'};
    Swal2.fire({input: 'radio', title: '针对哪些记录生成字图？', inputOptions: inputOptions}).then((result) => {
      if (!result.value)
        return;
      if (result.value === 'selected' && !ids) {
        return showWarning('提示', '请选择记录');
      }
      if (result.value === 'searched' && !location.search.trim()) {
        return showWarning('提示', '请先进行综合检索');
      }
      postApi('/char/gen_img', {data: {type: result.value, search: location.search, _ids: ids}}, (res) => {
        showSuccess('成功', '已启动脚本，请稍后刷新页面查看。');
      });
    });

  });

  // 查找重复
  $('.operation .btn-duplicate').click(function () {
    location.href = location.pathname + '?duplicate=true';
  });

  // 浏览结果
  $('.operation .btn-browse').click(function () {
    location.href = '/char/browse' + setQueryString('from', '/data/char', true);
  });

</script>
<script>
  /*---综合检索---*/
  var $searchModal = $("#searchModal");
  var inputFields = ['name', 'source', 'ocr_txt', 'txt', 'remark', 'cc'];
  var selectFields = ['txt_type'];
  $searchModal.find('.modal-confirm').click(function () {
    var search = '';
    inputFields.forEach(function (field) {
      var value = $searchModal.find('.' + field).val();
      if (value)
        search += '&' + field + '=' + value;
    });
    selectFields.forEach(function (field) {
      var value = $searchModal.find('.' + field + ' :selected').val();
      if (value)
        search += '&' + field + '=' + value;
    });
    if (!search.length)
      return showWarning('请输入查询条件');
    location.href = location.pathname + '?' + search.substr(1);
  });

  // 重置检索条件
  $searchModal.find('.reset').click(function () {
    inputFields.forEach(function (field) {
      $searchModal.find('.' + field).val('');
    });
  });

</script>
<script>
  /*---发布任务---*/
  var docs = [];
  var taskType = '';
  var $publishModal = $('#publishModal');
  var $publishResultModal = $('#publishResultModal');
</script>
{% end %}

