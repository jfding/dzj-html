{% extends "_task_do.html" %}

{% block custom-css %}
<link href="{{static_url('css/cut.css')}}" rel="stylesheet"/>
<style>
  .m-bottom > span {
    margin-left: 8px;
  }

  .full-bd {
    padding-bottom: 20px;
  }

  #readonly-tip {
    position: fixed;
    padding: 6px;
    border: 1px solid #ddd;
    border-radius: 4px;
    right: 4px;
    background-color: rgba(255, 255, 255, .5);
  }
</style>
{% end %}

{% block buttons %}
<div class="btn-group">
  <img src="{{static_url('imgs/icon_hlp.png')}}" class="btn-img" data-toggle="modal" data-target="#helpModal" title="帮助"/>
  <img src="{{static_url('imgs/icon_pic.png')}}" class="btn-img active" id="toggle-image" title="显隐图片"/>
  <img src="{{static_url('imgs/icon_blur.png')}}" class="btn-img active" id="toggle-blur" title="模糊"/>
  <img src="{{static_url('imgs/icon_zoom1.png')}}" class="btn-img" id="zoom-out" title="放大"/>
  <img src="{{static_url('imgs/icon_zoom0.png')}}" class="btn-img" id="zoom-reset" title="原始"/>
  <img src="{{static_url('imgs/icon_zoom2.png')}}" class="btn-img" id="zoom-in" title="缩小"/>
  <img src="{{static_url('imgs/icon_lr.png')}}" class="btn-img" id="undo" title="撤销"/>
  <img src="{{static_url('imgs/icon_rr.png')}}" class="btn-img" id="redo" title="重做"/>
  <img src="{{static_url('imgs/icon_boxes.png')}}" class="btn-img toggle-box" id="toggle-three" title="显隐所有"/>
  <img src="{{static_url('imgs/icon_block.png')}}" class="btn-img toggle-box" id="toggle-block" title="显隐栏框"/>
  <img src="{{static_url('imgs/icon_column.png')}}" class="btn-img toggle-box" id="toggle-column" title="显隐列框"/>
  <img src="{{static_url('imgs/icon_char.png')}}" class="btn-img toggle-box active" id="toggle-char" title="显隐字框"/>
</div>
<div class="btn-group hl-box" style="margin-left: 10px">
  <button type="button" class="btn btn-default btn-sm" id="toggle-all" title="显隐字框">所有<sup class="s-count"></sup></button>
  <button type="button" class="btn btn-default btn-sm" id="toggle-overlap" title="显隐重叠字框">重叠<sup class="s-count"></sup></button>
  <button type="button" class="btn btn-default btn-sm" id="toggle-narrow" title="显隐窄字框">窄框<sup class="s-count"></sup></button>
  <button type="button" class="btn btn-default btn-sm" id="toggle-flat" title="显隐扁字框">扁框<sup class="s-count"></sup></button>
  <button type="button" class="btn btn-default btn-sm" id="toggle-large" title="显隐大字框">大字<sup class="s-count"></sup></button>
  <button type="button" class="btn btn-default btn-sm" id="toggle-small" title="显隐小字框">小字<sup class="s-count"></sup></button>
</div>
{% end %}

{% block task-actions %}
  <img src="{{static_url('imgs/loading.gif')}}" class="btn-img hide" id="progress" title="进行中"/>
  <img src="{{static_url('imgs/icon_config.png')}}" class="btn-img {{'hide' if handler.readonly else ''}}" data-toggle="modal" data-target="#taskConfigModal" title="任务配置"/>
  <img src="{{static_url('imgs/icon_prev.png')}}" class="btn-img {{'hide' if handler.steps.get('is_first') else ''}}" id="prev-step" title="上一步"/>
  <img src="{{static_url('imgs/icon_return.png')}}" class="btn-img {{'' if handler.mode == 'do' else 'hide'}}" data-toggle="modal" data-target="#returnModal" title="退回"/>
  <img src="{{static_url('imgs/icon_save.png')}}" class="btn-img {{'hide' if handler.readonly else ''}}" id="save-task" title="保存"/>
  <img src="{{static_url('imgs/icon_next.png')}}" class="btn-img {{'hide' if handler.steps.get('is_last') else ''}}" id="next-step" title="下一步"/>
  <img src="{{static_url('imgs/icon_submit.png')}}" class="btn-img {{'' if handler.steps.get('is_last') and not handler.readonly else 'hide'}}" id="submit-task" title="提交"/>

  <img src="{{static_url('imgs/icon_block.png')}}" class="btn-img step-box" id="step-block" title="栏框校对"/>
  <img src="{{static_url('imgs/icon_char.png')}}" class="btn-img step-box active" id="step-char" title="字框校对"/>
  <img src="{{static_url('imgs/icon_column.png')}}" class="btn-img step-box" id="step-column" title="列框校对"/>
  <img src="{{static_url('imgs/char_icon9.png')}}" class="btn-img" id="finish-box" title="确认切分框"/>
{% end %}

{% block full-bd %}
<div class="bd" id="holder-container">
  {% if handler.readonly %}
  <div id="readonly-tip">当前是只读浏览方式，不能修改切分框</div>
  {% end %}
  <div id="holder"></div>
</div>
<div class="m-bottom" id="cut-info">
  <span class="cur-char"></span>
  <span class="char-info"></span>
</div>
{% end %}

{% block config-modal %}
{% module TaskConfigModal(handler.config_fields) %}
{% end %}

{% block custom-modal %}
<div id="helpModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="helpModal" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h4 class="modal-title">帮助文档<a class="more-help" href="/help">更多</a></h4>
      </div>
      <div class="modal-body">
        <div class="title">一、功能概述</div>
        <div class="intro">
          该功能用于检查图片的栏框、字框、列框、字序等是否正确，并对不正确的切分框及字序进行修改。本页面可以校对字框、列框和栏框。<br/>
          栏框要求将图片的正文（不包括边缘的页码等）用栏框框住，尽量不要包括正文外的边缘线。如果图片有多栏，则需要多个栏框。<br/>
          列框要求用列框将图片的每列文字框住。<br/>
          字框要求将图片的正文用字框框住，因文字紧凑而导致字框交叠时，首要原则是尽量把笔画都框住，其次是尽量减少交叠。<br/>
          <b>注：</b>请您看下第三部分的快捷键介绍。通过键盘快捷键进行操作，可以很好的提升效率。
        </div>
        <div class="title">二、功能按钮</div>
        <table class="table">
          <tr>
            <td><img src="{{static_url('imgs/icon_toggle.png')}}"/></td>
            <td>返回任务大厅</td>
          </tr>
          <tr>
            <td><img src="{{static_url('imgs/icon_pic.png')}}"/></td>
            <td>显示或隐藏图片。隐藏图片有助于看清所要校对的切分框</td>
          </tr>
          <tr>
            <td><img src="{{static_url('imgs/icon_char.png')}}"/></td>
            <td>显示或隐藏字框。隐藏字框有助于仔细辨认图片</td>
          </tr>
          <tr>
            <td><img src="{{static_url('imgs/icon_lr.png')}}"/></td>
            <td>撤销上一步操作</td>
          </tr>
          <tr>
            <td><img src="{{static_url('imgs/icon_rr.png')}}"/></td>
            <td>取消撤销</td>
          </tr>
          <tr>
            <td><span type="button" class="btn btn-default btn-sm">所有</span></td>
            <td>切换所有字框的颜色，有无色、白色不透明、蓝色半透明三种状态。<br/>白色不透明可以用于检查字框是否有遗漏，蓝色半透明则可以看清字迹</td>
          </tr>
          <tr>
            <td><span type="button" class="btn btn-default btn-sm">重叠</span></td>
            <td>高亮提示所有重叠的字框，从而帮助您检查这些字框是否正常</td>
          </tr>
          <tr>
            <td><span type="button" class="btn btn-default btn-sm">大框</span></td>
            <td>高亮提示所有的大框</td>
          </tr>
          <tr>
            <td><span type="button" class="btn btn-default btn-sm">窄框</span></td>
            <td>高亮提示所有的窄框</td>
          </tr>
          <tr>
            <td><span type="button" class="btn btn-default btn-sm">扁框</span></td>
            <td>高亮提示所有的扁框</td>
          </tr>
          {% include _task_help.html %}
        </table>
        <div class="title">三、快捷键</div>
        <table class="table" id="hot-key">
          <tr>
            <td>1/2/3/4/5</td>
            <td>图片放大1~5倍</td>
          </tr>
          <tr>
            <td>6/7/8/9</td>
            <td>图片缩小至60%~90%</td>
          </tr>
          <tr>
            <td>方向键</td>
            <td>按照方向键↑→↓←的指示，切换当前字框</td>
          </tr>
          <tr>
            <td>wsad</td>
            <td>按照指示（wsad代表上下左右四个方向）移动当前字框</td>
          </tr>
          <tr>
            <td>shift + 方向键</td>
            <td>shift表示扩大字框，方向键代表字框的四条边</td>
          </tr>
          <tr>
            <td>alt + 方向键</td>
            <td>alt表示缩小字框，方向键代表字框的四条边</td>
          </tr>
        </table>
      </div>
    </div>
  </div>
</div>
{% end %}

{% block custom-js %}
{% include _base_cut.html %}
<script>
  // 页面图
  var canvasName = taskType + step + docId;
  $.cut.create({
    holder: 'holder',
    name: canvasName,
    readonly: readonly,
    scrollContainer: '#holder-container',
    width: '{{handler.page["width"]}}',
    height: '{{handler.page["height"]}}',
    chars: '{{handler.page["chars"]}}',
    blocks: '{{handler.page["blocks"]}}',
    columns: '{{handler.page["columns"]}}',
    image: "{{handler.get_img(handler.page)}}"
  });
  $.cut.bindKeys();
  $.cut.switchCurrentBox(null);

  // 初始化设置
  if ($.cut.data.image.node) {
    $.cut.data.image.node.style.opacity = 0.2;
  }

  function updateThreeBoxes(blockActive, columnActive, charActive) {
    if (blockActive === undefined) {
      blockActive = localStorage.getItem('toggleBlock') || '-1';
      columnActive = localStorage.getItem('toggleColumn') || '-1';
      charActive = localStorage.getItem('toggleChar') || '1';
    }

    $('#toggle-block').toggleClass('active', blockActive === '1');
    $.cut.toggleBox(blockActive === '1', 'block');

    $('#toggle-column').toggleClass('active', columnActive === '1');
    $.cut.toggleBox(columnActive === '1', 'column');

    $('#toggle-char').addClass('active', charActive === '1');
    $.cut.toggleBox(charActive === '1', 'char');
  }
  updateThreeBoxes();

  $.cut.state.canHitBox = function (el) {
    var cls = el.data('class');
    var charActive = cutStep ? cutStep === 2 : $('#toggle-char').hasClass('active');
    var blockActive = cutStep ? cutStep === 1 : $('#toggle-block').hasClass('active');
    var columnActive = cutStep ? cutStep === 3 : $('#toggle-column').hasClass('active');
    var threeActive = $('#toggle-three').hasClass('active');
    if ((charActive || threeActive) && cls === 'char') {
      return true;
    }
    if ((columnActive || threeActive) && cls === 'column') {
      return true;
    }
    if ((blockActive || threeActive) && cls === 'block') {
      return true;
    }
  };

  $.cut.onBoxChanged(function (info, box, reason) {
    if (reason === 'added') {
      var charActive = cutStep ? cutStep === 2 : $('#toggle-char').hasClass('active');
      var blockActive = cutStep ? cutStep === 1 : $('#toggle-block').hasClass('active');
      var columnActive = cutStep ? cutStep === 3 : $('#toggle-column').hasClass('active');
      var active = (charActive ? 'char' : '') + (columnActive ? 'column' : '') + (blockActive ? 'block' : '');
      if (active.length > 6) {
        $.cut.removeBox();
        showWarning('无法创建新框', '当前显示有多种切分框，请仅选择其中一个，然后再创建');
      } else if (!active.length) {
        $.cut.removeBox();
        showWarning('无法创建新框', '当前没有显示任何切分框，请仅选择其中一个，然后再创建');
      } else {
        $.cut.setClass([info], active);
        updateUndo();
      }
    } else if (reason === 'removed' || reason === 'changed') {
      if ($.cut.data.hlType) {
        $.cut.clearHighlight();
        $.cut.highlightBoxes($.cut.data.hlType, false, true);
        $.cut.toggleClass([info.char_id], 'flash', false);
      }
      showHighLightCount();
      updateUndo();
    } else if (reason === 'navigate') {
      $('#cut-info > .cur-char').text('当前字框: ' + ($.cut.getCurrentCharID(true) || '未选中')
          + (info && info.is_small ? '，小字' : '') + ' ' + (info && info.txt || ''));
    } else if (reason === 'initial') {
      var invalid = $.cut.data.chars.map(function (c) {
        return /b0c/.test(c.char_id) && c.char_id;
      });
      $.cut.toggleClass(invalid, 'flash', true);
      $.cut.toggleBox(true, null, invalid);
    }

  }, true);

</script>

<script>
  $(document).ready(function () {
    var autoAdjust = localStorage.getItem('autoAdjust') || '是';
    if (autoAdjust.length) {
      $('#taskConfigModal .auto-adjust :radio[value=' + autoAdjust + ']').prop('checked', true);
    }
    var detectCol = localStorage.getItem('detectCol') || '是';
    if (detectCol.length) {
      $('#taskConfigModal .detect-col :radio[value=' + detectCol + ']').prop('checked', true);
    }
  });

  // 获取任务数据
  function getSubmitData(submit) {
    var autoAdjust = $('#taskConfigModal .auto-adjust :checked').val();
    var detectCol = $('#taskConfigModal .detect-col :checked').val();
    return {
      cut_step: cutStep,
      blocks: $.cut.exportBoxes('block'), columns: $.cut.exportBoxes('column'),
      chars: $.cut.exportBoxes('char'), submit: submit, step: steps['current'],
      auto_adjust: autoAdjust === '是', detect_col: detectCol === '是'
    };
  }

  // 是否自动调整栏框、列框大小，自适应检测字框在多列的情况
  $('#taskConfigModal .modal-confirm').click(function () {
    var autoAdjust = $('#taskConfigModal .auto-adjust :checked');
    if (autoAdjust.length)
      localStorage.setItem('autoAdjust', autoAdjust.val());
    var detectCol = $('#taskConfigModal .detect-col :checked');
    if (detectCol.length)
      localStorage.setItem('detectCol', detectCol.val());
    $('#taskConfigModal').modal('hide');
  });

  // 显示各种类型字框数量
  function showHighLightCount() {
    $('.hl-box > button').each(function (i, btn) {
      var type = btn.getAttribute('id').replace(/^.*-/, '');
      var boxes = $.cut.highlightBoxes(type, true);
      $(btn).find('.s-count').text(boxes.length);
    });
  }

  showHighLightCount();

  // 切换切分框状态
  $('.hl-box > button').click(function () {
    var type = this.getAttribute('id').replace(/^.*-/, '');
    $.cut.switchHighlightBoxes(type);
  });

  var cutStep = parseInt('{{handler.data.get("cut_step") or 0}}');

  function updateCutStep(showBoxes) {
    $('[data-target="#taskConfigModal"]').toggle(!cutStep);
    $('[data-target="#returnModal"]').toggle(!cutStep);
    $('#next-step').toggle(!cutStep);
    $('#prev-step').toggle(!cutStep);
    $('#submit-task').toggle(!cutStep);

    $('#toggle-three').toggle(!cutStep);
    $('#toggle-block').toggle(!cutStep);
    $('#toggle-column').toggle(!cutStep);
    $('#toggle-char').toggle(!cutStep);

    $('#step-block').toggle(!!cutStep);
    $('#step-char').toggle(!!cutStep);
    $('#step-column').toggle(!!cutStep);
    $('#finish-box').toggle(!!cutStep);

    $('#step-block').toggleClass('active', cutStep === 1);
    $('#step-char').toggleClass('active', cutStep === 2);
    $('#step-column').toggleClass('active', cutStep === 3);

    if (showBoxes && cutStep) {
      $.cut.toggleBox(cutStep === 1, 'block');
      $.cut.toggleBox(cutStep === 2, 'char');
      $.cut.toggleBox(cutStep === 3, 'column');
    }
    else if (showBoxes) {
      updateThreeBoxes();
    }
  }
  updateCutStep(true);

  $('#step-block').click(function () {
    cutStep = 1;
    updateCutStep(true);
  });
  $('#step-char').click(function () {
    cutStep = 2;
    updateCutStep(true);
  });
  $('#step-column').click(function () {
    cutStep = 3;
    updateCutStep(true);
  });
  $('#finish-box').click(function () {
    cutStep = 0;
    updateCutStep(true);
  });

</script>
{% end %}

{% block final-js %}
<script>
  // 保存之后
  afterSaved = function (submit, res, url) {
    if (!res.valid) {
      // 高亮未被覆盖的框
      // console.log(res.out_boxes);
      $.cut.toggleClass(res.out_boxes, 'highlight', true);
      $.cut.toggleClass(res.out_boxes, 'flash', true);
      $.cut.toggleBox(true, null, res.out_boxes);
      // 弹框提示
      var tips = '检测到<b style="color: red">' + res.message + '</b>' + '并高亮显示。';
      if (submit) {
        showConfirm('已保存。是否继续下一步？', tips, function () {
          goto(url, 1000);
        });
      } else {
        showWarning('已保存。提示', tips);
      }
    } else {
      if (submit) {
        goto(url, 1000);
      } else {
        showSuccess('成功', '已保存');
        location.reload();
      }
    }
  };
</script>

{% end %}
