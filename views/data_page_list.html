{% extends "com_list.html" %}
{% block custom-css %}
<style>
  #searchModal .modal-body h4, #searchModal .modal-body div {
    margin: 5px 0;
  }

  .select2-container {
    width: 100% !important;
  }

  .sty-table .action {
    color: #B8906F !important;
    cursor: pointer;
    font-size: 12px;
  }

  .sty-table .action:hover {
    color: #b33c2b !important;
    cursor: pointer;
    font-size: 12px;
  }

  .sty-table .tasks {
    width: 180px;
  }

  td.ocr, td.ocr_col {
    font-size: 12px;
  }

  td.blocks, td.columns, td.chars, td.orders, td.text {
    font-size: 12px;
    cursor: pointer;
    color: #B8906F;
  }

  .sty-table td a {
    font-size: 12px;
    margin-left: 5px;
    cursor: pointer;
  }

  .operation .btn-img {
    width: 22px;
    height: 22px;
  }

  #txt-content {
    font-size: 1.2em;
  }
</style>
{% end %}

{% block custom-modal %}
<div id="helpModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="helpModal"
     aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h4 class="modal-title">帮助文档</h4>
      </div>
      <div class="modal-body">
        <div class="title">一、简介</div>
        <div class="intro">
          页数据管理模块提供各种的页面的管理操作，包括批量删除、查找重复、更新分类、综合检索等，还可以针对具体的页面进行
          浏览、查看详情、更新基础数据、删除等操作。<br/>
          注：浏览指的是针对检索结果的浏览，浏览时可以对页面进行具体的操作。
        </div>
        <div class="title">二、操作</div>
        <table class="table">
          <tr>
            <td>批量删除</td>
            <td>批量删除选中的页面</td>
          </tr>
          <tr>
            <td>查找重复</td>
            <td>查找页编码重复的页面</td>
          </tr>
          <tr>
            <td>更新分类</td>
            <td>批量更新选中页面的分类。对页面分类后，以便进行管理</td>
          </tr>
          <tr>
            <td>综合检索</td>
            <td>
              可以对页面的各个字段进行检索。尤其值得注意的是，综合检索设置了“切分任务”、“文字任务”两种字段，包括“全未发布”、
              “已发布”、“全部完成”。比如要检索所有未发布切分任务的页面，就可以通过这个字段进行。
            </td>
          </tr>
          <tr>
            <td>浏览</td>
            <td>逐条浏览检索结果，在浏览页面时可以对页面进行各种操作</td>
          </tr>
          <tr>
            <td>详情</td>
            <td>查看页面详情</td>
          </tr>
          <tr>
            <td>更新</td>
            <td>更新页面基础信息</td>
          </tr>
          <tr>
            <td>删除</td>
            <td>删除页面</td>
          </tr>
        </table>
      </div>
    </div>
  </div>
</div>
<div id="configModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="configModal"
     aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h4 class="modal-title">配置列表</h4>
      </div>
      <div class="modal-body">
        <div class="select-column">
          {% for f in table_fields %}
          <label class="checkbox-inline"><input type="checkbox" class="{{f['id']}}" title="{{f['id']}}" checked>{{f['name']}}</label>
          {% end %}
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default waves-effect" data-dismiss="modal">关闭</button>
        <button type="button" class="btn btn-primary waves-effect waves-light modal-confirm">应用</button>
      </div>
    </div>
  </div>
</div>
<div id="searchModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="searchModal" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-body" style="min-height: 625px; padding: 0">
        <h4 class="col-sm-2 control-label">页编码</h4>
        <div class="col-sm-10">
          <input type="text" class="form-control name" value="{{params.get('name') or ''}}" placeholder="请输入页编码">
        </div>
        <h4 class="col-sm-2 control-label">分类</h4>
        <div class="col-sm-10">
          <input type="text" class="form-control source" value="{{params.get('source') or ''}}" placeholder="请输入分类">
        </div>
        <h4 class="col-sm-2 control-label">页面结构</h4>
        <div class="col-sm-10">
          <input type="text" class="form-control layout" value="{{params.get('layout') or ''}}" placeholder="请输入页面结构">
        </div>
        <h4 class="col-sm-2 control-label">切分等级</h4>
        <div class="col-sm-10">
          <input type="text" class="form-control level_box" value="{{params.get('level_box') or ''}}" placeholder="请输入，支持范围如>5、>=5、<10、<=10等，默认为等于">
        </div>
        <h4 class="col-sm-2 control-label">文本等级</h4>
        <div class="col-sm-10">
          <input type="text" class="form-control level_text" value="{{params.get('level_text') or ''}}" placeholder="请输入，支持范围如>5、>=5、<10、<=10等，默认为等于">
        </div>
        <h4 class="col-sm-2 control-label">切分已就绪</h4>
        <div class="col-sm-10">
          <select class="form-control box_ready">
            {% for v in ['', '是', '否'] %}
            {% if params.get('box_ready', '') == v %}
            <option value="{{v}}" selected="selected">{{v}}</option>
            {% else %}
            <option value="{{v}}">{{v}}</option>
            {% end %}
            {% end %}
          </select>
        </div>
        <h4 class="col-sm-2 control-label">切分任务</h4>
        <div class="col-sm-10">
          <select class="form-control cut_task">
            {% for k,v in group_task_statuses.items() %}
            {% if params.get('cut_task', '') == k %}
            <option value="{{k}}" selected="selected">{{v}}</option>
            {% else %}
            <option value="{{k}}">{{v}}</option>
            {% end %}
            {% end %}
          </select>
        </div>
        <h4 class="col-sm-2 control-label">切分校对</h4>
        <div class="col-sm-10">
          <select class="form-control cut_proof">
            {% for k,v in task_statuses.items() %}
            {% if params.get('cut_proof', '') == k %}
            <option value="{{k}}" selected="selected">{{v}}</option>
            {% else %}
            <option value="{{k}}">{{v}}</option>
            {% end %}
            {% end %}
          </select>
        </div>
        <h4 class="col-sm-2 control-label">切分审定</h4>
        <div class="col-sm-10">
          <select class="form-control cut_review">
            {% for k,v in task_statuses.items() %}
            {% if params.get('cut_review', '') == k %}
            <option value="{{k}}" selected="selected">{{v}}</option>
            {% else %}
            <option value="{{k}}">{{v}}</option>
            {% end %}
            {% end %}
          </select>
        </div>
        <h4 class="col-sm-2 control-label">文字任务</h4>
        <div class="col-sm-10">
          <select class="form-control text_task">
            {% for k,v in group_task_statuses.items() %}
            {% if params.get('text_task', '') == k %}
            <option value="{{k}}" selected="selected">{{v}}</option>
            {% else %}
            <option value="{{k}}">{{v}}</option>
            {% end %}
            {% end %}
          </select>
        </div>
        <h4 class="col-sm-2 control-label">文字校一</h4>
        <div class="col-sm-10">
          <select class="form-control text_proof_1">
            {% for k,v in task_statuses.items() %}
            {% if params.get('text_proof_1', '') == k %}
            <option value="{{k}}" selected="selected">{{v}}</option>
            {% else %}
            <option value="{{k}}">{{v}}</option>
            {% end %}
            {% end %}
          </select>
        </div>
        <h4 class="col-sm-2 control-label">文字校二</h4>
        <div class="col-sm-10">
          <select class="form-control text_proof_2">
            {% for k,v in task_statuses.items() %}
            {% if params.get('text_proof_2', '') == k %}
            <option value="{{k}}" selected="selected">{{v}}</option>
            {% else %}
            <option value="{{k}}">{{v}}</option>
            {% end %}
            {% end %}
          </select>
        </div>
        <h4 class="col-sm-2 control-label">文字校三</h4>
        <div class="col-sm-10">
          <select class="form-control text_proof_3">
            {% for k,v in task_statuses.items() %}
            {% if params.get('text_proof_3', '') == k %}
            <option value="{{k}}" selected="selected">{{v}}</option>
            {% else %}
            <option value="{{k}}">{{v}}</option>
            {% end %}
            {% end %}
          </select>
        </div>
        <h4 class="col-sm-2 control-label">文字审定</h4>
        <div class="col-sm-10">
          <select class="form-control text_review">
            {% for k,v in task_statuses.items() %}
            {% if params.get('text_review', '') == k %}
            <option value="{{k}}" selected="selected">{{v}}</option>
            {% else %}
            <option value="{{k}}">{{v}}</option>
            {% end %}
            {% end %}
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default waves-effect reset">重置</button>
        <button type="button" class="btn btn-default waves-effect" data-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary waves-effect waves-light modal-confirm">确定</button>
      </div>
    </div>
  </div>
</div>
<div id="inputModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="searchModal" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-body">
        <input type="text" class="form-control" value="" placeholder="请输入分类">
      </div>
      <div class="modal-footer" style="border: 0">
        <button type="button" class="btn btn-default waves-effect" data-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary waves-effect waves-light modal-confirm">确定</button>
      </div>
    </div>
  </div>
</div>

{% end %}

{% block custom-js %}
<script>
  // 批量更新分类
  $('.operation .bat-source').click(function () {
    var ids = $.map($('table tbody :checked'), function (item) {
      return $(item).parent().parent().attr('id');
    });
    if (!ids.length)
      return showWarning('请选择', '当前没有选中任何记录。');
    $('#inputModal').modal();
  });
  $('#inputModal .modal-confirm').click(function () {
    var source = $('#inputModal .modal-body input').val().trim();
    if (!source.length)
      return showWarning('请输入分类');
    var ids = $.map($('table tbody :checked'), function (item) {
      return $(item).parent().parent().attr('id');
    });
    postApi('/data/page/source', {data: {_ids: ids, source: source}}, function () {
      refresh(1000);
    });
  });

  // 查找重复
  $('.operation .btn-duplicate').click(function () {
    location.href = location.pathname + '?duplicate=true';
  });

  // 修改审定文本
  $('td.text').click(function () {
    if (!$(this).text().length)
      return;
    var name = $(this).siblings('.name').text();
    location.href = '/data/edit/text/' + name + '?from=' + location.pathname + location.search;
  });

  // 修改栏框、列框、字框、字序
  $('td.blocks, td.columns, td.chars, td.orders').click(function () {
    if (!$(this).text().length)
      return;
    var name = $(this).siblings('.name').text();
    var url = '/data/edit/box/' + name + '?step=' + $(this).attr('class');
    location.href = url + '&from=' + location.pathname + location.search;
  });

  // 解锁
  $('.lock-box a, .lock-text a').click(function () {
    if (!$(this).text().length)
      return;
    var node = $(this).parent();
    var name = node.siblings('.name').text().trim();
    var sharedField = node.attr('class').indexOf('box') !== -1 ? 'box' : 'text';
    var url = '/data/admin/unlock/' + sharedField + '/' + name;
    showConfirm("确定解锁吗？", "页面" + name + "的数据锁将被释放！", function () {
      postApi(url, {data: {}}, function () {
        showSuccess('成功', '已成功解锁。');
        refresh(1000);
      }, function (error) {
        showError('失败', error.message);
      });
    });
  });

  // 详情
  $('.action .btn-detail').click(function () {
    location.href = '/data/page/info/' + $(this).parent().siblings('.name').text();
  });

  // 浏览
  $('.action .btn-nav').click(function () {
    var name = $(this).parent().siblings('.name').text();
    location.href = '/data/page/' + name + location.search;
  });

</script>

<script>
  // 综合检索
  $searchModal = $("#searchModal");
  $searchModal.find('.modal-confirm').click(function () {
    var search = '';
    var fields = ['name', 'source', 'layout', 'level_box', 'level_text'];
    fields.forEach(function (field) {
      var value = $searchModal.find('.' + field).val();
      if (value)
        search += '&' + field + '=' + value;
    });
    fields = ['box_ready', 'cut_task', 'cut_proof', 'cut_review', 'text_task', 'text_proof_1', 'text_proof_1', 'text_proof_3', 'text_review'];
    fields.forEach(function (field) {
      var value = $searchModal.find('.' + field + ' :selected').val();
      if (value)
        search += '&' + field + '=' + value;
    });
    if (!search.length)
      return showWarning('请输入查询条件');
    location.href = location.pathname + '?' + search.substr(1);
  });

  // 重置检索条件
  $searchModal.find('.reset').click(function () {
    var fields = ['name', 'source', 'layout', 'level_box', 'level_text'];
    fields.forEach(function (field) {
      $searchModal.find('.' + field).val('');
    });
    fields = ['box_ready', 'cut_proof', 'cut_review', 'text_proof_1', 'text_proof_1', 'text_proof_3', 'text_review'];
    fields.forEach(function (field) {
      $searchModal.find('.' + field + ' :selected').removeAttr('selected');
    });
  });

</script>
{% end %}

