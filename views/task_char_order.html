<!DOCTYPE html>
{% from controller.task.base import TaskHandler as th %}
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>字序校对</title>
  {% include _base_meta.html %}
  {% include _base_css.html %}
  <link href="{{ static_url('assets/modal-effect/css/component.css') }}" rel="stylesheet">
  <link href="{{ static_url('css/cut.css') }}" rel="stylesheet" type="text/css"/>
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
  <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
  <![endif]-->

  <style>
    #info {
      position: fixed;
      bottom: 0;
      width: 100%;
      padding: 8px;
      background-color: #fff;
      border-top: 1px solid #ddd;
      opacity: .9;
      color: var(--Color_Brown_Darker);
    }

    #info > span + span {
      margin-left: 8px;
    }

    .sweet-overlay {
      background-color: transparent;
    }
  </style>

</head>

<body class="widescreen">
<div class="app-main">
  <div class="main">
    <div class="">

      <div class="m-header">
        <div class="left">
          <div class="back">
            {% set title, img = ('任务大厅', 'icon_lobby') if mode  == 'do' else ('返回', 'icon_back') %}
            <a onclick="leave()" title="{{title}}">
              <img src="{{ static_url('imgs/%s.png' % img) }}" class="btn-img"/>
            </a>
          </div>
          <div class="title" title="{{page['name']}}">{{th.task_types.get(task_type)}}</div>
          <div class="sub-title">/ 字框顺序</div>
          <div class="help">
            <img src="{{ static_url('imgs/help.png') }}" class="btn-img btn-help" title="帮助"/>
          </div>
          <div class="edit-btns">
            <img src="{{ static_url('imgs/icon_zoom1.png') }}" class="btn-img btn-enlarge" title="放大"/>
            <img src="{{ static_url('imgs/icon_zoom2.png') }}" class="btn-img btn-reduce" title="缩小"/>
            <img src="{{ static_url('imgs/icon_lr.png') }}" class="btn-img btn-undo" title="撤销"/>
            <img src="{{ static_url('imgs/icon_rr.png') }}" class="btn-img btn-redo" title="重做"/>
          </div>
          <div class="slice-btns">
            <div class="btn-group">
              <button type="button" class="btn btn-default btn-sm" id="switch-image" title="显示页面图">背景</button>
              <button type="button" class="btn btn-default btn-sm" id="toggle-columns" title="显示列框">列框</button>
              <button type="button" class="btn btn-default btn-sm" id="toggle-chars" title="显示字框">字框</button>
              <button type="button" class="btn btn-default btn-sm" id="switch-char-no" title="显示字框编号">编号</button>
              <button type="button" class="btn btn-default btn-sm" id="show-err-box" title="显示待修正的字框">查漏</button>
              <button type="button" class="btn btn-default btn-sm" id="apply" title="调整字框连线后重新设置字框编号">应用</button>
            </div>
          </div>
        </div>
        <div class="right">
          <div class="edit-btns">
            <div class="more">
              <div class="btn-group more-group hidden" role="group" aria-label="更多">
                {% for i, txt in enumerate(['原始字序', '重排(旧算法)', '重排(新算法)']) %}
                <a class="btn btn-default btn-sm" href="/task{{'' if mode == 'view' else '/' + mode}}/char_cut_proof/order/{{name}}{{'?layout=%d' % i}}">
                  {{txt}}
                </a>
                {% end %}
              </div>
              <img src="{{ static_url('imgs/icon_more.png') }}" class="btn-img btn-ed-box fl" title="更多"/>
            </div>
            {% if not readonly %}
            <img src="{{ static_url('imgs/icon_save.png') }}" class="btn-img btn-save" title="保存" style="margin-left: 20px;"/>
            {% end %}
            {% if not readonly and mode == 'do' %}
            <img src="{{ static_url('imgs/icon_submit.png') }}" class="btn-img btn-submit" title="提交"/>
            {% end %}
          </div>
        </div>
      </div>
      <div class="full-bd">
        <!-- holder为显示切分框和页面图的画布容器 -->
        <div id="holder"></div>
        <div id="info">
          <span class="cur-char"></span>
          <span class="col-info"></span>
          <span class="char-info"></span>
          <span class="target-char"></span>
        </div>
      </div>

    </div>
  </div>
</div>

{% include _base_js.html %}
{% include _cut_base.html %}
<script src="{{ static_url('js/cut/char_order.js') }}"></script>

<script>
  var blocks = decodeJSON('{{page["blocks"]}}');
  var columns = decodeJSON('{{page["columns"]}}');
  var chars = '{{page["chars"]}}';
  $.cut.create({
    orderMode: true,
    readonly: true,
    name: '{{name}}_order',
    width: '{{page["width"]}}',
    height: '{{page["height"]}}',
    holder: 'holder',
    image: "{{get_img(page.get('img_name', name), page.get('use_local_img'))}}",
    version: '{{box_version}}',
    chars: chars
  });

  $.cut.bindKeys();
  $.cut.bindCharOrderKeys();
  $.cut.addCharOrderLinks(decodeJSON('{{chars_col}}'));

</script>

<script>
  // 更新Undo
  function updateUndo() {
    $('.btn-undo').attr('src', $.cut.canUndo() ? "{{ static_url('imgs/icon_lr.png') }}"
        : "{{ static_url('imgs/icon_lr_not.png') }}");
    $('.btn-redo').attr('src', $.cut.canRedo() ? "{{ static_url('imgs/icon_rr.png') }}"
        : "{{ static_url('imgs/icon_rr_not.png') }}");
  }
  updateUndo();

  $('.btn-undo').click(function () {
    $.cut.undo();
    updateUndo();
  });

  $.cut.onBoxChanged(function (char, box, reason) {
    if (reason === 'navigate') {
      $('#info > .cur-char').text('当前字框: ' + ($.cut.getCurrentCharID(true) || '未选中'));
    }
    updateUndo();
  });

  $('#switch-image').click(function () {
    var style = $.cut.data.image.node.style;
    style.display = style.display === 'none' ? '' : 'none';
  });

  // 显示字序待修正的字框
  $('#show-err-box').click(function () {
    $.cut.showErrorBoxes(true);
  });
  setTimeout(function () {
    $.cut.showErrorBoxes();
  }, 100);

  // 缩小画布
  $('.btn-reduce').click(function () {
    if ($.cut.data.ratio > 0.5) {
      $.cut.setRatio($.cut.data.ratio * 0.9);
    }
  });

  // 放大画布
  $('.btn-enlarge').click(function () {
    if ($.cut.data.ratio < 5) {
      $.cut.setRatio($.cut.data.ratio * 1.5);
    }
  });

  // 显隐列框
  $('#toggle-columns').click(function () {
    $.cut.toggleColumns(columns);
  });

  // 显隐字框
  $('#toggle-chars').click(function () {
    $.cut.toggleBox('hide');
  });

  // 更多操作
  $('.btn-ed-box').click(function () {
    $('.more-group').toggleClass('hidden');
  });

  // 调整字框连线后重新设置字框编号
  $('#apply').click(function () {
    $.cut.applyLinks(blocks, columns);
  });

</script>

<script>
  // 保存任务
  $('.btn-save').on("click", function () {
    postApi('{{current_path.replace("/order", "")}}', {
      data: {
        submit: false,
        box_type: '{{box_type}}',
        boxes: JSON.stringify($.cut.exportBoxes())
      }
    }, function (data) {
      showSuccess('保存成功', '{{name}} ' + '已保存成功');
      setTimeout(function () {
        window.location.reload();
      }, 1000);
    });
	});

  // 提交任务
  $('.btn-submit').on("click", function () {
    postApi('{{current_path.replace("/order", "")}}', {
      data: {
      submit: true,
      box_type: '{{box_type}}',
      boxes: JSON.stringify($.cut.exportBoxes())
      }
    }, function () {
      // showSuccess('提交成功', '{{name}} ' + '已提交成功');
      pick('/task/pick/{{task_type}}');
    });
  });

  // 离开页面时解锁数据
  window.leave = function () {
    // 当前页面模式，包括view/do/update/edit等
    if ('{{mode}}' === 'edit') {
      postApi('/task/unlock/{{task_type}}/{{name}}', {}, function () {
        window.history.back();
      });
    } else if ('{{mode}}' === 'view') {
      window.history.back();
    } else {
      window.location = '/task/lobby/{{task_type}}';
    }
  };

</script>

{% import controller.errors as e %}
<script>
  // 领取新任务（从任务大厅拷贝）
  function pick(url, page_name) {
    var data = {data: page_name === undefined ? {} : {page_name: page_name}};
    postApi(url, data, function (res) {
      if (res && res.url) {
        window.location = res.url;
      }
    }, function (res) {
      error_callback(res);
    });
  }

  // 领取任务失败回调
  function error_callback(res) {
    console.log(res);
    if (res.code == '{{e.task_uncompleted[0]}}') {
      var info = {
        title: "是否继续未完成的任务？",
        text: "您还有未完成的任务" + res.uncompleted_name + "，不能领取新任务！",
        type: "warning",
        showCancelButton: true,
        confirmButtonColor: "#b8906f",
        confirmButtonText: "确定继续",
        cancelButtonText: "取消",
        closeOnConfirm: false
      };
      swal(info, function() {
        window.location = res.url;
      });
    } else if (res.code == '{{e.no_task_to_pick[0]}}') {
      showError('暂无新任务', res.message);
      setTimeout(function () {
        window.location = "/task/lobby/{{'text_proof' if 'text_proof' in task_type else task_type}}";
      }, 1000);
    } else if (res.code != 500) {
      var info = {
        title: "是否领取其它任务？",
        text: res.message,
        type: "warning",
        showCancelButton: true,
        confirmButtonColor: "#b8906f",
        confirmButtonText: "确定领取",
        cancelButtonText: "取消",
        closeOnConfirm: false
      };
      swal(info,function() {
          pick("/task/pick/{{task_type}}");
      });
    } else {
      showError('发生错误', res.message);
    }
  }

</script>

</body>
</html>