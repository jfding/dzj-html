{% extends "page_task_do.html" %}

{% block custom-css %}
<link href="{{static_url('css/cut.css')}}" rel="stylesheet"/>
{% end %}

{% block buttons %}
<div class="btn-group">
  <div id="help" class="btn-txt icon-help" data-toggle="tooltip" data-placement="bottom" title="帮助"></div>
  <div id="toggle-image" class="btn-txt icon-image active" data-toggle="tooltip" data-placement="bottom" title="显隐图片"></div>
  <div id="toggle-blur" class="btn-txt icon-blur active" data-toggle="tooltip" data-placement="bottom" title="模糊图片"></div>
  <div id="zoom-in" class="btn-txt icon-zoom-in" data-toggle="tooltip" data-placement="bottom" title="放大图片"></div>
  <div id="zoom-reset" class="btn-txt icon-zoom-back" data-toggle="tooltip" data-placement="bottom" title="原始大小"></div>
  <div id="zoom-out" class="btn-txt icon-zoom-out" data-toggle="tooltip" data-placement="bottom" title="缩小图片"></div>
  <div id="undo" class="btn-txt icon-undo" data-toggle="tooltip" data-placement="bottom" title="撤销"></div>
  <div id="redo" class="btn-txt icon-redo" data-toggle="tooltip" data-placement="bottom" title="重做"></div>
  <div id="toggle-three" class="btn-txt icon-three" data-toggle="tooltip" data-placement="bottom" title="显隐所有"></div>
  <div id="toggle-block" class="btn-txt icon-blocks" data-toggle="tooltip" data-placement="bottom" title="显隐栏框"></div>
  <div id="toggle-column" class="btn-txt icon-columns" data-toggle="tooltip" data-placement="bottom" title="显隐列框"></div>
  <div id="toggle-char" class="btn-txt icon-chars active" data-toggle="tooltip" data-placement="bottom" title="显隐字框"></div>
</div>
<div class="btn-group hl-box">
  <button id="toggle-all" class="btn btn-default btn-sm" type="button" title="显隐所有字框">所有<sup class="s-count"></sup></button>
  <button class="btn btn-default btn-sm" id="toggle-overlap" type="button" title="显隐重叠字框">重叠<sup class="s-count"></sup></button>
  <button id="toggle-narrow" class="btn btn-default btn-sm" type="button" title="显隐窄字框">窄框<sup class="s-count"></sup></button>
  <button id="toggle-flat" class="btn btn-default btn-sm" type="button" title="显隐扁字框">扁框<sup class="s-count"></sup></button>
  <button id="toggle-large" class="btn btn-default btn-sm" type="button" title="显隐大字框">大框<sup class="s-count"></sup></button>
  <button id="toggle-small" class="btn btn-default btn-sm" type="button" title="显隐小字框">小框<sup class="s-count"></sup></button>
</div>
{% end %}

{% block m-body %}
<div class="bd" id="holder-container">
  <div id="holder"></div>
</div>
{% end %}

{% block m-footer %}
<div class="m-footer">
  <span class="cur-char"></span>
  <span class="char-info"></span>
</div>
{% end %}

{% block config-modal %}
{% module TaskConfigModal(config_fields) %}
{% end %}

{% block custom-modal %}
<div id="helpModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="helpModal" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h4 class="modal-title">帮助文档<a class="more-help" href="/help">更多</a></h4>
      </div>
      <div class="modal-body">
        <div class="title">一、功能概述</div>
        <div class="intro">
          该功能用于检查图片的栏框、字框、列框、字序等是否正确，并对不正确的切分框及字序进行修改。本页面可以校对字框、列框和栏框。<br/>
          栏框要求将图片的正文（不包括边缘的页码等）用栏框框住，尽量不要包括正文外的边缘线。如果图片有多栏，则需要多个栏框。<br/>
          列框要求用列框将图片的每列文字框住。<br/>
          字框要求将图片的正文用字框框住，因文字紧凑而导致字框交叠时，首要原则是尽量把笔画都框住，其次是尽量减少交叠。<br/>
          <b>注：</b>请您看下第三部分的快捷键介绍。通过键盘快捷键进行操作，可以很好的提升效率。
        </div>
        <div class="title">二、功能按钮</div>
        <table class="table">
          <tr>
            <td><i class="btn-txt icon-return-back"></i></td>
            <td>返回任务大厅</td>
          </tr>
          <tr>
            <td><i class="btn-txt icon-image"></i></td>
            <td>显示或隐藏图片。隐藏图片有助于看清所要校对的切分框</td>
          </tr>
          <tr>
            <td><i class="btn-txt icon-chars"></i></td>
            <td>显示或隐藏字框。隐藏字框有助于仔细辨认图片</td>
          </tr>
          <tr>
            <td><i class="btn-txt icon-undo"></i></td>
            <td>撤销上一步操作</td>
          </tr>
          <tr>
            <td><i class="btn-txt icon-redo"></i></td>
            <td>取消撤销</td>
          </tr>
          <tr>
            <td><span type="button" class="btn btn-default btn-sm">所有</span></td>
            <td>切换所有字框的颜色，有无色、白色不透明、蓝色半透明三种状态。<br/>白色不透明可以用于检查字框是否有遗漏，蓝色半透明则可以看清字迹</td>
          </tr>
          <tr>
            <td><span type="button" class="btn btn-default btn-sm">重叠</span></td>
            <td>高亮提示所有重叠的字框，从而帮助您检查这些字框是否正常</td>
          </tr>
          <tr>
            <td><span type="button" class="btn btn-default btn-sm">大框</span></td>
            <td>高亮提示所有的大框</td>
          </tr>
          <tr>
            <td><span type="button" class="btn btn-default btn-sm">窄框</span></td>
            <td>高亮提示所有的窄框</td>
          </tr>
          <tr>
            <td><span type="button" class="btn btn-default btn-sm">扁框</span></td>
            <td>高亮提示所有的扁框</td>
          </tr>
          {% include _task_help.html %}
        </table>
        <div class="title">三、快捷键</div>
        <table class="table" id="hot-key">
          <tr>
            <td>1/2/3/4/5</td>
            <td>图片放大1~5倍</td>
          </tr>
          <tr>
            <td>6/7/8/9</td>
            <td>图片缩小至60%~90%</td>
          </tr>
          <tr>
            <td>方向键</td>
            <td>按照方向键↑→↓←的指示，切换当前字框</td>
          </tr>
          <tr>
            <td>wsad</td>
            <td>按照指示（wsad代表上下左右四个方向）移动当前字框</td>
          </tr>
          <tr>
            <td>shift + 方向键</td>
            <td>shift表示扩大字框，方向键代表字框的四条边</td>
          </tr>
          <tr>
            <td>alt + 方向键</td>
            <td>alt表示缩小字框，方向键代表字框的四条边</td>
          </tr>
        </table>
      </div>
    </div>
  </div>
</div>
{% end %}

{% block custom-js %}
{% include _base_cut.html %}
<script>
  // 页面图
  $.cut.create({
    holder: 'holder',
    readonly: readonly,
    name: taskType + step + docId,
    scrollContainer: '#holder-container',
    image: "{{img_url}}",
    width: '{{page["width"]}}',
    height: '{{page["height"]}}',
    chars: '{{page["chars"]}}',
    blocks: '{{page["blocks"]}}',
    columns: '{{page["columns"]}}',
  });
  $.cut.bindKeys();
  $.cut.switchCurrentBox(null);

  // 初始化设置
  $.cut.data.image.node ? $.cut.data.image.node.style.opacity = 0.2 : null;
  $.cut.toggleBox(getStorage('toggleBlock', '-1') === '1', 'block');
  $.cut.toggleBox(getStorage('toggleColumn', '-1') === '1', 'column');
  $.cut.toggleBox(getStorage('toggleChar', '-1') === '1', 'char');
  $('#toggle-block').toggleClass('active', getStorage('toggleBlock', '-1') === '1');
  $('#toggle-column').toggleClass('active', getStorage('toggleColumn', '-1') === '1');
  $('#toggle-char').toggleClass('active', getStorage('toggleChar', '-1') === '1');

  $(document).ready(function () {
    $cfgModal.find('.detect-col :radio[value=' + getStorage('detectCol', '是') + ']').prop('checked', true);
    $cfgModal.find('.auto-adjust :radio[value=' + getStorage('autoAdjust', '是') + ']').prop('checked', true);
  });

  $.cut.state.canHitBox = function (el) {
    var cls = el.data('class');
    var charActive = $('#toggle-char').hasClass('active');
    var blockActive = $('#toggle-block').hasClass('active');
    var columnActive = $('#toggle-column').hasClass('active');
    var threeActive = $('#toggle-three').hasClass('active');
    if ((charActive || threeActive) && cls === 'char')
      return true;
    if ((columnActive || threeActive) && cls === 'column')
      return true;
    if ((blockActive || threeActive) && cls === 'block')
      return true;
  };

  $.cut.onBoxChanged(function (info, box, reason) {
    if (reason === 'added') {
      var charActive = $('#toggle-char').hasClass('active');
      var blockActive = $('#toggle-block').hasClass('active');
      var columnActive = $('#toggle-column').hasClass('active');
      var active = (charActive ? 'char' : '') + (columnActive ? 'column' : '') + (blockActive ? 'block' : '');
      if (active.length > 6) {
        $.cut.removeBox();
        bsShow('失败！', '当前显示有多种切分框，请仅选择其中一个，然后再创建。', 'warning');
      } else if (!active.length) {
        $.cut.removeBox();
        bsShow('失败！', '当前没有显示任何切分框，请仅选择其中一个，然后再创建。', 'warning');
      } else {
        $.cut.setClass([info], active);
        updateUndo();
      }
    } else if (reason === 'removed' || reason === 'changed') {
      if ($.cut.data.hlType) {
        $.cut.clearHighlight();
        $.cut.highlightBoxes($.cut.data.hlType, false, true);
        $.cut.toggleClass([info.char_id], 'flash', false);
      }
      showHighLightCount();
      updateUndo();
    } else if (reason === 'navigate') {
      $('.m-footer > .cur-char').text('当前字框: ' + ($.cut.getCurrentCharID(true) || '未选中')
          + (info && info.is_small ? '，小字' : '') + ' ' + (info && info.txt || ''));
    } else if (reason === 'initial') {
      var invalid = $.cut.data.chars.map(function (c) {
        return /b0c/.test(c.char_id) && c.char_id;
      });
      $.cut.toggleClass(invalid, 'flash', true);
      $.cut.toggleBox(true, null, invalid);
    }
  }, true);

</script>

<script>
  // 获取任务数据
  function getTaskData() {
    return {
      blocks: $.cut.exportBoxes('block'), columns: $.cut.exportBoxes('column'),
      chars: $.cut.exportBoxes('char'), step: steps.current,
      auto_adjust: $cfgModal.find('.detect-col :checked').val() === '是',
      detect_col: $cfgModal.find('.auto-adjust :checked').val() === '是',
    };
  }

  // 是否自动调整栏框、列框大小，自适应检测字框在多列的情况
  $('#taskConfigModal .modal-confirm').on('click', function () {
    setStorage('detectCol', $cfgModal.find('.detect-col :checked').val(), true);
    setStorage('autoAdjust', $cfgModal.find('.auto-adjust :checked').val(), true);
    $cfgModal.modal('hide');
  });

  // 显示各种类型字框数量
  function showHighLightCount() {
    $('.hl-box > button').each(function (i, btn) {
      var type = btn.getAttribute('id').replace(/^.*-/, '');
      var boxes = $.cut.highlightBoxes(type, true);
      $(btn).find('.s-count').text(boxes.length);
    });
  }

  showHighLightCount();

  // 切换切分框状态
  $('.hl-box > button').on('click', function () {
    var type = this.getAttribute('id').replace(/^.*-/, '');
    $.cut.switchHighlightBoxes(type);
  });

</script>
{% end %}

{% block final-js %}
<script>
  // 保存之后
  afterSaved = function (type, res, url) {
    if (res.valid) {
      type === 'next' ? goto(url, 1000) : bsShow('成功！', '已保存。') || location.reload();
    } else {
      // 高亮未被覆盖的框
      $.cut.toggleClass(res.out_boxes, 'highlight flash', true);
      $.cut.toggleBox(true, null, res.out_boxes);
      // 提示
      let tips = `检测到<b style="color:red">${res.message}</b>并高亮显示。`;
      if (type === 'next') {
        tips += `<a href="${url}">继续</a>`;
      }
      bsShow('已保存，发现错误!', tips, 'warning');
    }
  };
</script>
{% end %}
