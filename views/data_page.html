{% extends "com_list.html" %}

{% block custom-css %}
<style>
  .sty-table .btn-text, .sty-table .btn-lock {
    color: #B8906F !important;
    cursor: pointer;
  }

  #txt-content {
    font-size: 1.2em;
  }
</style>
{% end %}

{% block table %}
<table class="sty-table">
  <thead>
  <tr>
    <th><span class="sort {{'active' if 'page_code' in order else ''}}" title="page_code">
      页编码<span class="ion-arrow-down-b {{'toggle' if order == 'page_code' else ''}}"></span>
      </span></th>
    <th><span class="sort {{'active' if 'uni_sutra_code' in order else ''}}" title="uni_sutra_code">
      统一经编码<span class="ion-arrow-down-b {{'toggle' if order == 'uni_sutra_code' else ''}}"></span>
      </span></th>
    <th class="hide"><span class="sort {{'active' if 'reel_code' in order else ''}}" title="reel_code">
      经编码<span class="ion-arrow-down-b {{'toggle' if order == 'reel_code' else ''}}"></span>
      </span></th>
    <th><span class="sort {{'active' if 'reel_code' in order else ''}}" title="reel_code">
      卷编码<span class="ion-arrow-down-b {{'toggle' if order == 'reel_code' else ''}}"></span>
      </span></th>
    <th><span>卷内页序号</span></th>
    <th><span>页面结构</span></th>
    <th><span>字框OCR</span></th>
    <th><span>列框OCR</span></th>
    <th><span>审定文本</span></th>
    <th><span>文本锁</span></th>
    <th><span>栏框</span></th>
    <th><span>列框</span></th>
    <th><span>字框</span></th>
    <th><span>字序</span></th>
    <th><span>字框锁</span></th>
    <th><span>操作</span></th>
  </tr>
  </thead>

  <tbody>
  {% for d in docs %}
  <tr id="{{d['_id']}}">
    <td class="name"><a href="/page/{{d.get('name')}}">{{d.get('name')}}</a></td>
    <td class="uni_sutra_code">{{d.get('uni_sutra_code') or ''}}</td>
    <td class="sutra_code hide">{{d.get('sutra_code') or ''}}</td>
    <td class="reel_code">{{d.get('reel_code') or ''}}</td>
    <td class="reel_page_no">{{d.get('reel_page_no') or ''}}</td>
    <td class="layout">{{d.get('layout') or ''}}</td>
    <td class="ocr btn-text" title="ocr">{{'修改' if d.get('ocr') else ''}}</td>
    <td class="ocr_col btn-text" title="ocr_col">{{'修改' if d.get('ocr_col') else ''}}</td>
    <td class="text"><a href="/data/edit/text/{{d.get('name')}}?from=/data/page">
      {{'修改' if d.get('text') else ''}}
    </a></td>
    <td class="text_lock btn-lock" title="text">{{'解锁' if handler.prop(d, 'lock.text.is_temp') else ''}}</td>
    <td class="blocks"><a href="/data/edit/box/{{d.get('name')}}?step=block_box&from=/data/page">
      {{'修改 %d栏' % len(d['blocks']) if d.get('blocks') else ''}}
    </a></td>
    <td class="columns"><a href="/data/edit/box/{{d.get('name')}}?step=column_box&from=/data/page">
      {{'修改 %d列' % len(d['columns']) if d.get('columns') else ''}}
    </a></td>
    <td class="chars"><a href="/data/edit/box/{{d.get('name')}}?step=char_box&from=/data/page">
      {{'修改 %d字' % len(d['chars']) if d.get('chars') else ''}}
    </a></td>
    <td class="order"><a href="/data/edit/box/{{d.get('name')}}?step=char_order&from=/data/page">
      {{'修改' if d.get('chars') else ''}}
    </a></td>
    <td class="box_lock btn-lock" title="box">{{'解锁' if handler.prop(d, 'lock.box.is_temp') else ''}}</td>
    <td class="action">
      {% set info = {f: handler.prop(d, f.replace('-', '.'), '') for f in model.info_fields} %}
      <span class="hide info">{{dumps(info)}}</span>
      <a href="/data/page/{{d.get('_id')}}">详情</a>
      <a class="btn-update">修改</a>
      <a class="btn-remove">删除</a>
    </td>
  </tr>
  {% end %}
  </tbody>
</table>
{% end %}

{% block custom-modal %}
<div id="txtModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="txtModal" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h4 class="modal-title">修改文本</h4>
      </div>
      <div class="modal-body">
        <input type="hidden" id="page-id">
        <input type="hidden" id="page-name">
        <input type="hidden" id="txt-type">
        <textarea type="text" id="txt-content" rows="20" class="form-control"></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default waves-effect" data-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary waves-effect waves-light modal-confirm">确定</button>
      </div>
    </div>
  </div>
</div>
{% end %}

{% block custom-js %}
<script>
  $('.btn-lock').click(function () {
    var sharedField = $(this).attr('title');
    var pageName = $(this).parent().find('.name').text();
    var url = '/data/admin/unlock/' + sharedField + '/' + pageName;
    showConfirm("确定解锁吗？", "页面" + pageName + "的数据锁将被释放！", function () {
      postApi(url, {data: {}}, function () {
        showSuccess('成功', '已成功解锁。');
        refresh(1000);
      }, function (error) {
        showError('失败', error.message);
      });
    });
  });

  var $txtModal = $('#txtModal');
  $('.btn-text').click(function () {
    var id = $(this).parent().attr('id');
    var txtType = $(this).attr('title');
    var data = getData(id);
    var trans = {ocr: '字框OCR文本', ocr_col: '列框OCR文本'};
    $txtModal.find('#page-id').val(data._id);
    $txtModal.find('#page-name').val(data.name);
    $txtModal.find('#txt-type').val($(this).attr('title'));
    $txtModal.find('.modal-title').html(trans[txtType]);
    $txtModal.find('#txt-content').html(data[txtType].replace(/\|/g, '\n'));
    $txtModal.modal();
  });

  $txtModal.find('.modal-confirm').click(function () {
    var _id = $txtModal.find('#page-id').val();
    var name = $txtModal.find('#page-name').val();
    var txtType = $txtModal.find('#txt-type').val();
    var txtContent = $txtModal.find('#txt-content').val();
    var data = {name: name, _id: _id};
    data[txtType] = txtContent.replace(/\n/g, '\|');
    postApi('/data/page', {data: data}, function () {
      showSuccess('成功', '已成功修改。');
      refresh(1000);
    }, function (error) {
      showError('失败', error.message);
    });
  });

</script>
{% end %}

